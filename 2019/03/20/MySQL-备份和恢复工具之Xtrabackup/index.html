<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "ca4015c6"
    });
  daovoice('update');
  </script>

  <meta name="description" content="更新于：2020.01更新内容：xtrabackup旧版命令进行全量备份和增量备份的合并不生效问题">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL-备份和恢复工具之Xtrabackup">
<meta property="og:url" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/index.html">
<meta property="og:site_name" content="Coool&#39;s Blog">
<meta property="og:description" content="更新于：2020.01更新内容：xtrabackup旧版命令进行全量备份和增量备份的合并不生效问题">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup备份过程.png">
<meta property="og:image" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/innodb存储结构.png">
<meta property="og:image" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup增量备份逻辑示意图.png">
<meta property="og:image" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup全量备份过程分析.png">
<meta property="og:updated_time" content="2020-11-07T10:02:52.138Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL-备份和恢复工具之Xtrabackup">
<meta name="twitter:description" content="更新于：2020.01更新内容：xtrabackup旧版命令进行全量备份和增量备份的合并不生效问题">
<meta name="twitter:image" content="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup备份过程.png">






  <link rel="canonical" href="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MySQL-备份和恢复工具之Xtrabackup | Coool's Blog</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">
<!-- 音频播放 -->
<script src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://myhkw.cn/player/js/player.js" id="myhk" key="159888076870" m="1"></script>
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coool's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">As we watch our love grow.</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-address-card"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">20</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">24</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">57</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  


</div>
    </header>

    <a href="https://github.com/liukkui" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub">
      <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
      </svg>
      </a>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liukui.tech/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="空腹吃早餐">
      <meta itemprop="description" content="如果你也喜欢杰伦那我们就是好朋友 C'est la vie">
      <meta itemprop="image" content="/images/haha.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coool's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL-备份和恢复工具之Xtrabackup
              
            
          </h1>
        

        <div class="post-meta">
                  
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-20 08:00:00" itemprop="dateCreated datePublished" datetime="2019-03-20T08:00:00+08:00">2019-03-20</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">24k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">22 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>更新于：2020.01<br>更新内容：xtrabackup旧版命令进行全量备份和增量备份的合并不生效问题<br><a id="more"></a></p>
<h3 id="Xtrabackup"><a href="#Xtrabackup" class="headerlink" title="Xtrabackup"></a>Xtrabackup</h3><p><a href="www.percona.com">Percona官网</a></p>
<h3 id="1-xtrabackup基础"><a href="#1-xtrabackup基础" class="headerlink" title="1.xtrabackup基础"></a>1.xtrabackup基础</h3><p><img src="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup备份过程.png" alt="xtrabackup备份过程"><br><img src="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/innodb存储结构.png" alt="innodb存储结构"><br><img src="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup增量备份逻辑示意图.png" alt="xtrabackup增量备份逻辑示意图"></p>
<pre><code>MySQL数据库自带的mysqldump逻辑备份工具适合于数据量小且业务受短时间影响没有太关系的业务,而且对于mysqldump来说：它能实现对MyISAM存储引擎做温备,对InnoDB存储引擎温备和其中一个单个事务基础之上完成热备;如果数据量大、业务的连续性要求较高的要求且真正期望在线上做真正意义上的热备而且还是物理备份，那么xtrabackup是一个很好的备份工具;
1.xtrabackup备份过程,如上图示：
    1.innobackupex启动后，会先fork一个进程，用于启动xtrabackup，然后等待xtrabackup备份ibd数据文件；
    2.xtrabackup在备份innoDB数据有2种线程：redo拷贝线程和ibd数据拷贝线程。xtrabackup进程开始执行后，会启动一个redo拷贝的线程，用于从最新的checkpoint点开始顺序拷贝redo.log；再启动ibd数据拷贝线程，进行拷贝ibd数据。这里是先启动redo拷贝线程的。在此阶段，innobackupex进行处于等待状态（等待文件被创建）
    3.xtrabackup拷贝完成ibd数据文件后，会通知innobackupex（通过创建文件），同时xtrabackup进入等待状态（redo线程依旧在拷贝redo.log）;
    4.innobackupex收到xtrabackup通知后哦，执行FLUSH TABLES WITH READ LOCK（FTWRL），取得一致性位点，然后开始备份非InnoDB文件（如frm、MYD、MYI、CSV、opt、par等格式的文件），在拷贝非InnoDB文件的过程当中，数据库处于全局只读状态;
    5.当innobackup拷贝完所有的非InnoDB文件后，会通知xtrabackup，通知完成后，进入等待状态;
    6.xtrabackup收到innobackupex备份完成的通知后，会停止redo拷贝线程，然后通知innobackupex，redo.log文件拷贝完成;
    7.innobackupex收到redo.log备份完成后，就进行解锁操作，执行：UNLOCK TABLES;
    8.最后innbackupex和xtrabackup进程各自释放资源，写备份元数据信息等，innobackupex等xtrabackup子进程结束后退出;
2.关于xtrabackup的2.3版本的重要说明
    1.在Xtrabackup2.3版之前包括4个可执行文件： 
        1.innobackupex:   #Perl脚本
        2.xtrabackup:     #C/C++编译的二进制 
        3.xbcrypt:        #加解密 
        4.xbstream:       #支持并发写的流文件格式
        安装完Xtrabackup2.3版后会有两个主要的备份工具：xtrabackup与innobackupex,其中：
            1.xtrabackup是一个C程序,只能用来备份innodb和xtradb的表，不能备份myisam表;
            2.innobackupex是一个perl脚本,用来备份非InnoDB表，同时会调用xtrabackup命令来备份InnoDB表,所以它是在xtrabackup之上做了一层封装实现的;
    2.在Xtrabackup2.3版之后都统一使用xtrabackup
        在2.3版本之后innobackupex功能全部集成到xtrabackup里面，只有一个binary程序，另外为了兼容考虑,innobackupex作为xtrabackup的软链接，即xtrabackup现在支持非Innodb表备份，并且在以后的版本中，将会删除innobackupex，只保留xtrabackup；
    不管是哪个版本,只要学会使用innobackupex，再使用xtrabackup时也不会有什么问题;
3.xtrabackup的一些概念
    1.xtrabackup支持对innodb进行热备、增量备份、差量备份
    2.xtrabackup支持对myisam进行温备，因为在备份myisam表时，会对myisam表添加读锁，而且不能对myisam表进行增量备份，每次备份myisam数据都是全量，即使名义上是增量，但是实际上仍然是全量；
    3.与mysqldump不同，xtrabackup是一种物理备份工具，但是它是需要通过协议连接到mysql服务端（这一点与mysqldump相同，它们都是客户端工具，都需要连接到服务端）,然后读取并复制innodb底层的&quot;数据块&quot;，完成所谓的&quot;物理备份&quot;;
4.xtrabackup怎样实现物理备份的？
    xtrabackup是怎样对innodb存储引擎实现所谓的物理备份的呢？这和innodb的存储结构有关：
        1.如上图是innodb存储引擎的逻辑结构,逻辑单元从大到小分别为:表空间（tablesapce）、段（segment）、区（extent）、页（page）、行（row），如上图所示每个大的逻辑单元中都包含了N个小的逻辑单元；
        2.而我们只要关心上图中的extent逻辑单元和page逻辑单元即可，我们可以把上图中Extent区域中的每个&quot;小方块(page)&quot;当做xtrabackup需要备份的&quot;数据块&quot;，因为数据存放于行中，行存在于page中，所以我们备份对应page，即可备份出对应的数据，当我们使用xtrabackup连接到mysql服务端的时候，xtrabackup会读取innodb中的page，进行备份
5.xtrabackup怎样实现增量备份的？
    1.每个Page都有自己的LSN号码，LSN是一个全局递增的号码，每次对page中的记录进行修改时，都会有对应的LSN号码，因为LSN是全局递增的，所以，LSN只会越来越大，之后的修改产生的LSN肯定比之前的操作产生的LSN大，每个page中的数据被更改时，都会在这个page中记录下本次的LSN号码，所以，如果这个page中记录的LSN越大，就证明这个Page中的数据越新（最近被修改）；
    2.而xtrabackup就是通过LSN，实现对innodb表的增量备份的，每次备份开始时，xtrabackup会记录下当前备份到的LSN号码，当下次进行增量备份时，xtrabackup就只会拷贝出LSN大于上次记录的page，那些LSN号码小于上次记录的page则会被跳过，如果page中的LSN小于上次备份时记录的LSN号码，则证明这个page自从上次备份以来并没有被修改过，同理，如果page中的LSN大于上次备份时记录的LSN号，则证明这个page在上次备份以后，已经被修改了，所以，备份出这些page，即可实现增量备份的目的；
    3.下面通过简易的示意图理解xtrabackup的增量备份逻辑：
        如上图是xtrabackup增量备份逻辑示意图：
        1.假设我们第一次备份的数据如下，所有数据由如下6个page组成，上图中的黄色方块代表page，黄色方块右上角的号码代表当前page的LSN，从上图可以看出，目前最大的LSN号码为5；
        2.假设备份完成后，我们修改了数据，而这次修改的数据存在于上图中的page C与page E中，所以上图中的pageC与pageE的LSN就变成了6，因为刚才最大的LSN是5，而LSN是全局递增的，所以，如果page中的LSN越大，证明此page越新，被修改的时间越近，如上图所示
        3.如果此时要做增量备份，那么我们只需要备份出自上次备份以后变化的数据即可，所以，我们只要从上图中找到LSN大于5的Page，即上图中的pageC与pageE，即可得出变化的增量数据，得出上图中的增量page后，再将增量page覆盖到上次的备份中，即可得到最新的数据；
6.xtrabackup的prepare操作--&gt;非常重要的逻辑
    1.当我们开始备份innodb数据时，我们还需要同时备份对应的事务日志，因为在开始备份时，有些事务已经存在于事务日志中，这些事务可能已经提交了，但是还没有同步到datafile中，所以我们要重放这些已经提交的事务，有些事务可能还未提交，所以我们要回滚这些没有提交的事务；
    2.xtrabackup就是这样做的，在备份开始时，同时运作两个线程：一个线程负责备份innodb中的page，另一个线程负责备份innodb的事务日志（redo log），事务日志都会被xtrabackup记录到自己的日志文件中，那么备份结束后，我们会得到两份文件，一份是不可用的备份文件，一份是备份时的事务日志，备份文件之所以不可用，是因为有一部分不确定的数据可能在事务日志中，而且热备过程中数据也可能会发生改变，所以我们要通过这两份文件，制作出一份可用的备份文件，没错，就是通过应用事务日志的方式，让最终的备份成为一个可用的备份，事务日志会被应用，事务日志文件中已经提交的事务需要replayed，未提交的事务需要roolback，整个过程类似于mysql崩溃后恢复的过程，但是这个过程在xtrabackup中被称为&quot;prepare&quot;，&quot;prepare&quot;操作保证了备份出的数据的一致性，没有经过prepare的备份数据是不可用的，我们可以理解为如果想要得到一个可用的备份，则需要进行这些所谓的&quot;准备&quot;工作或者所谓的&quot;数据恢复&quot;的工作；
    3.说到这里，就必须考虑另外一个问题：
        我们刚才提到，想要备份数据可用，则必须进行prepare工作，那么先不考虑存在增量备份的情况，当不存在增量备份时，我们在对数据进行prepare时，需要应用事务日志，对于已经写入redologfile中但是还没有写入datafile中的已提交事务进行同步，对于未提交的的事务所作出的修改进行回滚，这是没有增量的情况下，但是，如果存在增量备份时，xtrabackup会将所有增量都合并到之前的全量上，然后使用最后的完整数据进行还原，那么，在合并数据的过程中，上一次未提交的事务有可能在下次的增量备份中已经提交了，所以，如果存在多个增量备份的时候，我们在进行prepare工作时，只需要将已经提交的事务同步到数据文件中即可，未提交的事务不用进行回滚，因为在增量中，这些事务可能已经提交了，只需要在最后一份增量数据进行prepare时，将对应的未提交的事务回滚即可；
    4.而我们知道，xtrabackup能对innodb做热备，能对myisam做温备，对myisam做温备时会对myisam表添加读锁，也就是说，备份出的myisam表中的数据应该是一致的 ，但是如果数据库中既有myisam表又有innodb表时，如果想要整体的所有数据都一致，则只能以myisam的一致性时间点作为最终备份的一致性时间点，所以xtrabackup在备份时，会先备份inndb数据，备份完innodb数据后，再备份非innodb数据，当我们需要将备份的数据&quot;prepare&quot;时，只操作innodb数据即可，非innodb数据不用动，prepare完成后，innodb的一致性时间点与非innodb数据的一致性时间点是相同的；
</code></pre><h3 id="2-xtrabackup安装和常用备份参数选项"><a href="#2-xtrabackup安装和常用备份参数选项" class="headerlink" title="2.xtrabackup安装和常用备份参数选项"></a>2.xtrabackup安装和常用备份参数选项</h3><p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">最新版Xtrabackup下载地址</a><br><a href="https://www.percona.com/doc/percona-xtrabackup/2.4/manual.html" target="_blank" rel="noopener">官方的xtrabackup2.4版本的在线用户手册</a><br><a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/genindex.html" target="_blank" rel="noopener">xtrabackup的参数选项说明</a></p>
<pre><code>1.安装2.4.12版本的xtrabackup
    官网提供了xtrabackup的源码下载，也提供了各个发行版的rpm包，此处我们使用rpm包进行安装，根据你的操作系统版本，选择对应版本的rpm包,此处下载的rpm包版本是：percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm
    ~]# yum install percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm -y
        注意：会依赖安装很多程序包,需要提前配置好base源与epel源；
    ~]# rpm -pql percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm
        /usr/bin/innobackupex
        /usr/bin/xtrabackup
        /usr/bin/xbcrypt
        /usr/bin/xbstream     #这就是上文所说的4个可执行程序
    ~]# mysql
        MariaDB [(none)]&gt; create user &apos;xtrauser&apos;@&apos;%&apos; identified by &apos;1234&apos;;
            #创建一个专门用来备份数据库的用户xtrauser
        MariaDB [(none)]&gt; grant all on *.* to xtrauser@&apos;%&apos; identified by &apos;1234&apos;;    #授权
        MariaDB [(none)]&gt; FLUSH PRIVILEGES;
    ~]# mysql -uxtrauser -p1234 -h192.168.34.118    #测试登录并查看用户权限
        MariaDB [(none)]&gt; show grants for xtrauser@&apos;%&apos;;
        +------------------------------------------------------------------------------------------------------------------+
        | Grants for xtrauser@%                                                                                            |
        +------------------------------------------------------------------------------------------------------------------+
        | GRANT ALL PRIVILEGES ON *.* TO &apos;xtrauser&apos;@&apos;%&apos; IDENTIFIED BY PASSWORD &apos;*A4B6157319038724E3560894F7F932C8886EBFCF&apos; |
        +------------------------------------------------------------------------------------------------------------------+
    备注：
        上面的xtrauser用户权限是最高权限,如果希望只是最小权限的用户进行备份,可以如下修改即可：
        &gt; create user &apos;xtrauser&apos;@&apos;%&apos; identified by &apos;1234&apos;;
        &gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM &apos;xtrauser&apos;;　　#回收此用户所有权限
        &gt; GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO &apos;xtrauser&apos;@&apos;localhost&apos;;　　#授权刷新、锁定表、用户查看服务器状态
        &gt; FLUSH PRIVILEGES;　　#刷新授权表
2.innobackupex备份、prepare、还原的语法和相关常用参数
    注意：
        这里只列出innobackupex命令的语法和相关备份参数,需要注意的是新版xtrabackup中移除了innobackupex命令,本文会在最后新增新版xtrabackup和旧版xtrabackup间备份和还原命令的区别;
    ~]# innobackupex --help      #所有参数选项说明参考上文官方链接
    Usage: [xtrabackup [--defaults-file=#] --backup | xtrabackup [--defaults-file=#] --prepare] [OPTIONS]
    1.全量备份和增量备份操作的相关选项：
        --user      #表示备份数据库使用的账号
        --password  #使用的账号密码
        --host      #表示备份数据库的主机地址 
        --port      #指定端口,默认3306
        --databases 
            #数据库名,如果要指定多个数据库,彼此间需要以空格隔开;如：
                &quot;xtra_test dba_test&quot;，同时，在指定某数据库时，也可以只指定其中的某张表;如:&quot;mydatabase.mytable&quot;;但是该选项对innodb引擎表无效，它还是会备份所有innodb表
        --defaults-file 
            #指定从哪个文件读取Mysql配置，必须放在命令行第一个选项位置
        --incremental
            #该选项表示创建一个增量备份，需要指定--incremental-basedir 
        --incremental-basedir
            #该选项指定为前一次全备份或增量备份的目录，与--incremental同时使用
        --incremental-dir       #该选项表示还原时增量备份的目录 
        --include=name：指定表名，格式：databasename.tablename 
    2.Prepare相关的参数选项和语法：
        语法：innobackupex --apply-log [option]  BACKUP-DIR 
        相关选项：
        --apply-log         #对备份进行&quot;Prepare&quot;预处理操作
            也就是上文所解释的xtrabackup的&quot;Prepare&quot;操作,因为一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态;&quot;Prepare&quot;的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。
        --redo-only         #不回滚未提交事务(重要参数)
        --copy-back         #恢复备份目录
        --use-memory        #非必须项
            #在&quot;prepare&quot;过程中和--apply-log选项一起使用,指定使用的内存的大小,默认是100M,推荐分配1G内存给&quot;prepare&quot;过程来提高其完成备份的速度； 
        --export            #表示开启可导出单独的表之后再导入其他Mysql中 
    3.还原相关的参数选项和语法：
        语法：innobackupex --copy-back [选项] BACKUP-DIR 
        相关选项：
        --copy-back     #做数据恢复时将备份数据文件拷贝到MySQL服务器的datadir 
        --move-back     
            #这个选项与--copy-back相似，唯一的区别是它不拷贝文件，而是移动文件到目的地。这个选项移除backup文件，用时候必须小心。使用场景：没有足够的磁盘空间同事保留数据文件和Backup副本 
3.xtrabackup全量和增量备份生成的相关文件说明
    使用innobackupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关 于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件。这些文件会被保存至一个以时间命名的目录中,在备份时，innobackupex还会在备份目录中创建如下文件：
    1.xtrabackup_info
        innobackupex工具执行时的相关信息，包括版本，备份选项， 备份时长，备份LSN(log sequence number日志序列号)，BINLOG的位置 
    2.xtrabackup_checkpoints
        备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN范围信息,每个InnoDB页(通常为16k大小)都会包含一个日志序列号LSN。LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面 最近是如何发生改变的;
    3.xtrabackup_binlog_info
        此文件记录了备份开始时二进制日志文件的&quot;位置（position）&quot;,可利用实现基于binlog的恢复;
    4.backup-my.cnf：备份命令用到的配置选项信息,也就是本次备份的概要信息，此文件中的信息还是比较全面的
    5.xtrabackup_logfile：记录了备份过程中的日志，在对数据进行prepare时需要通过日志将数据还原成一致的可用的数据;
4.xtrabackup还原时的注意事项：
    1.datadir目录必须为空
        除非使用--force-non-emptydirectorires选项指定，否则--copy-backup选项不会覆盖 
    2.在restore恢复之前,必须关闭MySQL实例，不能将一个运行中的实例restore到datadir目录中；
    3.由于文件属性会被保留，大部分情况下需要在启动实例之前将文件的属主改为mysql，这些文件将属于创建备份的用户：
        chown -R mysql:mysql /data/mysql 
    --force-non-empty-directories：指定该参数时候，使得innobackupex -copy-back或--move-back选项转移文件到非空目录，已存在的文件不会被覆盖。如果--copy-back和--move-back文件需要从备份目录拷贝一个在datadir已经存在的文件，会报错失败;
</code></pre><h4 id="2-1-xtrabackup全量备份及恢复"><a href="#2-1-xtrabackup全量备份及恢复" class="headerlink" title="2.1.xtrabackup全量备份及恢复"></a>2.1.xtrabackup全量备份及恢复</h4><p><img src="/2019/03/20/MySQL-备份和恢复工具之Xtrabackup/xtrabackup全量备份过程分析.png" alt="xtrabackup全量备份过程分析"></p>
<pre><code>全量备份和恢复的步骤：
    1.全量备份：
        ~]# innobackupex --user=DBUSER --password=DBUSERPASS --host=HOSTIP --defaults-file=/etc/my.cnf /path/to/BACKUP-DIR/
    2.恢复
        ~]# innobackupex --apply-log /backups/2019-02-10_21-10-20/
        ~]# innobackupex --copy-back --defaults-file=/etc/my.cnf  /backups/2019-02-10_21-10-20/
        注：需要先进行&quot;Prepare&quot;操作再进行还原操作
1.对当前数据库进行全量备份
    ~]# innobackupex --default-file=/etc/my.cnf --user=xtrauser --password=1234 --host=192.168.34.118 /data1/
        #使用用户密码把当前主机上的所有数据库备份到/data1/目录中
    如上图,备份过程分析：
        1.在第一部分中先备份innodb数据文件
            由于数据库中既有myisam类型又有innodb类型的数据库,可以看出，xtrabackup先备份了innodb数据文件，然后才开始备份非innodb数据；
        2.在第二部分中备份非innodb数据时会先施加读锁
            在备份非innodb数据文件（MYiSAM）之前，施加了读锁；
        3.第三部分生成LSN号、记录二进制位置等
            可以看出在备份完成后，可以看到备份时的LSN号，当下次进行增量备份时，xtrabackup就只备份大于此号的page即可，而且信息中输出了备份的位置，可以看到xtrabackup自动在指定的备份目录中创建了一个备份目录，目录名称为当前的日期与时间，同时，信息中还输出了备份时二进制日志处于哪个二进制日志文件中以及其对应的postion，在进行时间点还原时，我们可以通过这些信息确定二进制日志的重放起始位置；
2.查看备份目录中的文件：
    ~]# ll /data1/2019-02-10_21-10-20
        total 18460
        -rw-r----- 1 root root      431 Nov  7 00:43 backup-my.cnf
        drwxr-x--- 2 root root      272 Nov  7 00:43 hellodb
        -rw-r----- 1 root root 18874368 Nov  7 00:43 ibdata1
        drwxr-x--- 2 root root     4096 Nov  7 00:43 mysql
        drwxr-x--- 2 root root     4096 Nov  7 00:43 performance_schema
        drwxr-x--- 2 root root       20 Nov  7 00:43 test
        -rw-r----- 1 root root       21 Nov  7 00:43 xtrabackup_binlog_info
        -rw-r----- 1 root root      113 Nov  7 00:43 xtrabackup_checkpoints
        -rw-r----- 1 root root      522 Nov  7 00:43 xtrabackup_info
        -rw-r----- 1 root root     2560 Nov  7 00:43 xtrabackup_logfile
        可以看出：
            1.与数据库的名称相同的是各个数据库的数据文件备份目录
            2.有一个innodb的共享表空间文件：ibdata1
                需要注意的是：如果只是使用xtrabackup备份所有数据库中的某一个库，那么必须保证在创建这个数据库时，已经开启了innodb_file_per_table=ON参数，否则将无法单独备份数据库服务器中的某一个数据库；
            3.其他5个文件就是上文所说的xtrabackup备份生成记录信息的文件;
    ~]# cat xtrabackup_checkpoints 
        backup_type = full-backuped
        from_lsn = 0
        to_lsn = 1636662
        last_lsn = 1636662
        compact = 0
        recover_binlog_info = 0
    查看xtrabackup_checkpoints文件中的内容可以看出这是一次全量备份,以及此次备份的LSN号;
3.恢复
    假设我们误删除了其中一个库hellodb或者需要在一台新数据库节点上恢复数据（需要事先安装xtrabackup命令）,我们可以根据上次的全量备份进行恢复,步骤如下：
    1.先进行&quot;Prepare&quot;操作
        上文说过备份出的数据并不能直接使用，因为备份出的数据是不一致的，我们需要将同时备份出的事务日志应用到备份中，才能得到一份完整、一致、可用的数据，xtrabackup称这一步操作为&quot;Prepare&quot;：
        ~]# innobackupex --apply-log /data1/2019-02-10_21-10-20/ 
            #将目录中的日志应用到备份数据中
        注意：
            1.确保输出信息的最下方看到completed OK字样说明&quot;Prepare&quot;成功
            2.因为这个示例中并没有什么多少事务日志，所以很快应用成功了，如果你要备份的数据量巨大，那么备份时长会变长，期间备份的事务日志容量有可能会很大;可以使用--use-memory选项为xtrabackup分配更多的内存加速准备工作；
            ~]# innobackupex --apply-log --use-memory=1G /data1/2020-11-07_00-43-21/ 
    2.恢复
        在&quot;Prepare&quot;操作后得到一份可用的、数据一致的备份后再通过innobackupex命令恢复即可;恢复过程有几个注意事项：
        1.先停止mysql
            ~]# systemctl stop mariadb
        2.删除mysql数据目录的数据
            ~]# rm -rf /data/mysql3/*
        3.将备份数据拷贝到mysql的数据目录
            ~]# innobackupex --/datadir=/data/mysql3 --copy-back /data1/2019-02-10_21-10-20/
                #由于原先mysql的数据目录是/data/mysql3,需要使用--/datadir指定
            确保该命令最后的输出信息是completed OK!即可;
        4.查看数据目录并修改属主属组
            ~]# ll /data/mysql3/
            ~]# chown -R mysql.mysql /data/mysql3
                #一定要修改成mysql启动用户的属主属组否则mysql将无法正常启动
        5.重新启动mysql并验证数据完整性
            ~]# systemctl start mariadb
            #启动后登陆验证数据完整性即可;
全量备份和恢复步骤总结：
    1.全量备份数据库到指定目录
    2.先进行&quot;prepare&quot;将目录中的日志应用到备份数据
    3.停止mysql实例
    4.删除mysql数据目录中的所有数据(数据目录必须为空)
    5.恢复数据导mysql数据目录中
    6.修改属主属组信息
    7.重新启动mysql实例并验证数据完整性
</code></pre><h4 id="2-2-xtrabackup增量备份及恢复"><a href="#2-2-xtrabackup增量备份及恢复" class="headerlink" title="2.2.xtrabackup增量备份及恢复"></a>2.2.xtrabackup增量备份及恢复</h4><pre><code>全量备份是差量与增量的基础，因为差量备份只能针对于上一次全量备份，增量备份则可以针对上一次任何一种备份，上一次备份可以是全量、差量、或者增量，但是不管怎么样，总是要有一份全量备份作为基础的，不管是增量备份还是差量备份，都是对于innodb表来说的，对于myisam表，即使执行了所谓的&quot;增量&quot;备份，其实也是全量备份;
注意事项：
    1.xtrabackup版本不同恢复命令的选项也是不同的,在旧版的xtrabackup中是使用--apply-log和--redo-only进行全量备份和增量备份的合并操作，而新版的xtrabackup是使用--prepare和--apply-log-only选项进行全量备份和增量备份的合并操作;
    2.如果使用--apply-log和--redo-only发现全量备份和增量备份的合并后，全量备份的backup_type没有变成log-applied,说明要使用第二种参数选项进行合并,本文就出现使用旧版命令合并后不生效的情况，所以在下文的全量备份和增量备份的合并操作是使用-prepare和--apply-log-only选项进行的合并才生效的;
1.先备份一个全量备份
    ~]# innobackupex --default-file=/etc/my.cnf --user=xtrauser --password=1234 --host=192.168.34.118 /data1/
    ~]# ls /data1/
        2019-02-10_22-01-10    #此次全量备份的数据目录
    ~]# cat /data1/2019-02-10_22-01-10/xtrabackup_checkpoints 
        backup_type = full-backuped
        from_lsn = 0
        to_lsn = 1636914
        last_lsn = 1636914
        compact = 0
        recover_binlog_info = 0
    查看本次全量备份的xtrabackup_checkpoints文件，可以发现，此文件中记录了此次备份的类型为&quot;全量备份&quot;，备份page的LSN范围为0到1636914;
2.修改数据库中的数据然后进行第一次增量备份
    ~]# mysql
        MariaDB [hellodb]&gt; delete from hellodb.students where StuID=1;
        Query OK, 1 row affected (0.01 sec)
        MariaDB [hellodb]&gt; insert into hellodb.students set Name=&quot;test&quot;,Age=20;
        Query OK, 1 row affected (0.01 sec)
        #删除students表中的一行数据并增加一条数据
    ~]# innobackupex --default-file=/etc/my.cnf --user=xtrauser --password=1234 --host=192.168.34.118 --incremental /data2 --incremental-basedir=/data1/2019-02-10_22-01-10/
    命令中的：
        --incremental选项表示本次备份是一个增量备份（其实这次备份既可以算是增量，也可以算作差量）;本次增量备份将备份至/data2目录下,本次增量备份是针对于/data1/2019-02-10_22-01-10/的增量备份;
    ~]# ls /data2
        2019-02-10_22-03-40    #增量备份的目录
    ~]# cat /data2/2019-02-10_22-03-40/xtrabackup_checkpoints
        backup_type = incremental
        from_lsn = 1636914
        to_lsn = 1638953
        last_lsn = 1638953
        compact = 0
        recover_binlog_info = 0
        注：从第一次增量备份目录中的xtrabackup_checkpoints文件内容可以看出,本次备份是一个增量备份,而且本次备份的起始LSN正是上次全量备份的last_lsn号;
3.再次修改数据进行第二次增量备份
    ~]# mysql
        MariaDB [hellodb]&gt; insert into hellodb.students set Name=&quot;test1&quot;,Age=21;
        Query OK, 1 row affected (0.01 sec)
        #再增加一行数据
    同样，这次的增量备份是基于上一次备份进行的，所以，我们要指定上一次的备份位置，只不过，上一次备份也是增量备份罢了；
    ~]# innobackupex --default-file=/etc/my.cnf --user=xtrauser --password=1234 --host=192.168.34.118 --incremental /data2 --incremental-basedir=/data2/2020-11-07_02-00-03/
        注意：第二次增量备份是在第一次增量备份的基础上做的，所以--incremental-basedir要写第一次增量备份的目录
    ~]# ls /data2
        2019-02-10_22-03-40 2019-02-10_22-08-01   #第一次和第二次增量备份目录
    ~]# cat /data2/2019-02-10_22-08-01/xtrabackup_checkpoints 
        backup_type = incremental
        from_lsn = 1638953
        to_lsn = 1639248
        last_lsn = 1639248
        compact = 0
        recover_binlog_info = 0
        注：从第二次增量备份目录中的xtrabackup_checkpoints文件内容可以看出,本次备份还是一个增量备份,而且本次备份的起始LSN正是第一次增量备份的last_lsn号;
4.还原
    还是假设我们误删除了其中一个库hellodb或者需要在一台新数据库节点上恢复数据（需要事先安装xtrabackup命令）,增量备份还原除了全量备份，还有多个增量备份，所以准备工作要进行多次：
    1.先对全量备份进行&quot;prepare&quot;工作
        ~]# xtrabackup --prepare --apply-log-only --target-dir=/data1/2019-02-10_22-01-10/
        注意：这里和之前全量备份的&quot;prepare&quot;的命令多了--apply-log-only参数选项；
        1.这个选项表示在进行准备（应用日志）工作时，只进行redo操作，因为在备份开始时，有的事务日志已经提交了，但是还没有完全应用到数据文件中，有的事务日志还没有提交，这些没有提交的事务需要进行回滚操作，在进行&quot;准备&quot;工作时，如果添加了--apply-log-only选项，则只会重做已提交但是未应用的事务，而不会回滚未提交的事务；
        2.在上文跟的全量备份恢复过程中没有添加--apply-log-only参数选项是因为：
            前文中只还原了一个全量备份，全量备份之后没有任何其他备份需要合并，而此刻则不同，除了全量备份，后面还有对应的增量备份，那么全量备份中未提交的事务有可能在后面的增量备份中已经提交了，所以，在准备&quot;最后一份备份&quot;之前的&quot;备份&quot;时，都不用进行回滚操作，只在最后一次备份中进行回滚操作即可;
        述命令执行完成后，完全备份已经准备完成
    2.将第一次进行的增量备份合并到第一步准备好的完全备份中
        ~]# xtrabackup --prepare --apply-log-only --target-dir=/data1/2019-02-10_22-01-10/ --incremental-dir=/data2/2019-02-10_22-03-40/
        注：
            仍然使用了--apply-log-only选项，并且使用了--incremental-dir选项指定对应的目录为增量备份文件的目录，上述命令表示对增量备份进行准备工作，并且把准备好的增量备份合并到对应的全量备份中
        执行完上述命令后，则表示第一份增量备份已经整理完毕，并且已经将增量合并到了对应的全量备份中，如果此时，查看全量备份中的xtrabackup_checkpoints文件，会发现全量备份的备份类型已经变为了&quot;log-applied&quot;,如下所示，也就是说这个备份已经经历过了日志应用的过程（已经做过了准备工作），而且，对应的最大的LSN号码为1638953，此LSN正是第一次增量的结束LSN，也就是说，我们已经将第一次增量与全量整合在了一起
        ~]# cat /data1/2019-02-10_22-01-10/xtrabackup_checkpoints 
            backup_type = log-applied
            from_lsn = 0
            to_lsn = 1638953
            last_lsn = 1638953
            compact = 0
            recover_binlog_info = 0
    3.将第二次进行的增量备份合并到第二步准备好的完全备份中
        ~]# xtrabackup --prepare --target-dir=/data1/2019-02-10_22-01-10/ --incremental-dir=/data2/2019-02-10_22-08-01/
        注：
            因为这是最后一份备份数据，所以并不用添加--apply-log-only选项，事务日志需要应用，该提交的提交，该回滚的回滚，上述命令中，--incremental-dir对应的目录为最后一次增量备份的目录，表示准备最后一次的增量备份，并且将准备好的增量备份合并到上次准备好的全量备份中
        上述命令执行成功后，再次查看对应的全量备份目录中的xtrabackup_checkpoints文件，发现对应的LSN号码已经变为最后一次增量备份的结束LSN号码了：
        ~]# cat /data1/2019-02-10_22-01-10/xtrabackup_checkpoints 
            backup_type = log-applied
            from_lsn = 0
            to_lsn = 1639248
            last_lsn = 1639248
            compact = 0
            recover_binlog_info = 0
        到目前为止，所有准备工作已经完成，我们已经把所有增量备份都合并到了最初的第一份全量备份中，现在，我们只要通过这一份全量备份即可恢复数据库；
    4.停止数据库并删除mysql数据目录中的所有数据(数据目录必须为空)
        ~]# systemctl stop mariadb
        ~]# rm -rf /data/mysql3/*
    5.恢复数据导mysql数据目录中
        ~]# xtrabackup --/datadir=/data/mysql3 --copy-back --target-dir=/data1/2019-02-10_22-01-10/
    6.修改属主属组信息
        ~]# chown -R mysql.mysql /data/mysql3
    7.重新启动mysql实例并验证数据完整性
        ~]# systemctl start mariadb
            #启动后登陆验证数据完整性即可;
增量备份和恢复步骤总结：
    1.先进行全量备份数据库到指定目录
    2.针对上次全量备份进行第一次增量备份或差异备份
    3.针对上次全量备份或增量备份进行第二次增量备份或差异备份
    4.先对最开始的全量备份进行prepare工作
    5.将第一个增量备份合并到全量备份中
    6.将第二个增量备份合并到全量备份中
    7.停止mysql实例并删除mysql数据目录中的所有数据(数据目录必须为空)
    8.恢复数据导mysql数据目录中
    9.修改属主属组信息
    10.重新启动mysql实例并验证数据完整性
</code></pre><h3 id="3-xtrabackup单表导出和导入功能"><a href="#3-xtrabackup单表导出和导入功能" class="headerlink" title="3.xtrabackup单表导出和导入功能"></a>3.xtrabackup单表导出和导入功能</h3><pre><code>默认情况下，InnoDB表不能通过直接复制表文件的方式在mysql服务器之间进行移植，即便使用了innodb_file_per_table选项，而使用Xtrabackup工具可以实现此种功能，不过，此时需要&quot;导出&quot;表的mysql服务器启用了innodb_file_per_table选项(严格来说，是要导出的表在其创建之前，mysql服务器就启用了innodb_file_per_table选项)，并且&quot;导入&quot;表的服务器职期间同时启用了innodb_file_per_table和innodb_expand_import选项；
1.导出表
    1.导出表是在备份的prepare阶段进行的，这就意味着需要先做一次完全备份
    2.因此一旦完全备份完成，就可以在prepar过程中通过--export选项将某表导出了；
    ~]# innobackupex /root/backups/
    ~]# cd 2019-05-12_19-27-26/
    ~]# innobackupex --apply-log --export /root/backups/2019-05-12_19-27-26/
        #将多有表都导出单个可用的表
        此命令回味每个innoDB表的表空间创建一个以.exp结尾的文件，这些以.exp结尾的文件就可以用于导入其他服务器；
2.导入表
    1.要在mysql服务器上导入来自其他服务器的某innoDB表，需要现在当前服务器上创建一个根原表表结构一致的表，而后才能实现将表导入；
        mysql&gt; use mydatabase;
        mysql&gt; create table mytable (...) ENGINE=InnoDB;
        #通过show create mydatabase.mytable;查看之前的这个表创建时语句，然后再其他mysql上再创建一个即可；
    2.然后将此表的表空间删除
        mysql&gt; ALTER table mydatabase.mytable DISCARD TABLESPACE
        ~]# cd /data/mysql/mydatabase  #进入mydatabase库
            #可以看到mytable的frm文件还有，ibd文件被删除了
    3.接下来，将来自于&quot;导出&quot;表的服务器的mytable表的mytable.ibd和mytable.exp文件复制到当前服务器的数据目录，然后使用如下命令将其&quot;导入&quot;；
        ~]# cd /data/mysql/mydatabase
        ~]# cp /root/backups/2019-05-12_19-27-26/mytable.exp mytable.ibd /data/mysql/mydatabase
        #将这两个文件复制到目录下即可
    mysql&gt; ALTER table mydatabase.mytable IMPORT TABLESPACE;
</code></pre><h3 id="新增内容：4-新版xtrabackup和旧版xtrabackup备份和还原的区别"><a href="#新增内容：4-新版xtrabackup和旧版xtrabackup备份和还原的区别" class="headerlink" title="新增内容：4.新版xtrabackup和旧版xtrabackup备份和还原的区别"></a>新增内容：4.新版xtrabackup和旧版xtrabackup备份和还原的区别</h3><pre><code>由于新版的xtrabackup中删除了innobackupex命令,所以只能使用xtrabackup命令;上文增量备份的示例中增量备份使用innobackupex命令,而还原过程只能使用xtrabackup命令,因为使用innobackupex命令合并不生效;下面列出新版xtrabackup和旧版xtrabackup全量备份和增量备份以及还原的命令：
1.旧版xtrabackup全量备份和增量备份使用innobackupex命令
    1.全量备份：
        ~]# innobackupex --user=DBUSER --password=DBUSERPASS --host=HOSTIP --defaults-file=/etc/my.cnf /path/to/BACKUP-DIR/
        #直接指定备份使用的用户密码使用的配置文件和备份文件存放的目录即可；
    2.增量备份：
        ~]# innobackupex --user=DBUSER --password=DBUSERPASS --host=HOSTIP --defaults-file=/etc/my.cnf --incremental /path2/ --incremental-basedir=/path1/to/BACKUP-DIR/
        #增量备份使用--incremental和--incremental-basedir指定增量备份目录和上一次的增量或全量备份目录
    3.全量备份的&quot;prepare&quot;过程
        ~]# innobackupex --apply-log /path/to/BACKUP-DIR/
        #旧版的xtrabackup是使用innobackupex和--apply-log选择指定备份文件目录实现&quot;prepare&quot;过程
    4.增量备份的&quot;prepare&quot;准备过程
        1.增量备份中的全量备份&quot;prepare&quot;过程
            ~]# innobackupex --apply-log --redo-only /path/to/BACKUP-DIR/
        2.增量备份合并到全量备份：
            ~]# innobackupex  --apply-log --redo-only /path1/to/BACKUP-DIR/ --incremental-dir=/path2/to/BACKUP-DIR/
        #旧版的是使用innobackupex和--redo-only进行&quot;prepare&quot;过程,需要注意的是最后一个增量备份合并到全量备份时是不需要再加--redo-only选项的
    5.还原：
        ~]# innobackupex --copy-back --defaults-file=/etc/my.cnf /path/to/BACKUP-DIR/
        #还原是使用innobackupex和--copy-back选项进行还原
2.新版xtrabackup全量备份和增量备份只有xtrabackup命令
    1.全量备份
        ~]# xtrabackup --backup --target-dir=/backup1/
            #新版xtrabackup使用--backup和--target-dir指定备份目录
    2.增量备份
        ~]# xtrabackup --backup --target-dir=/backup2/ --incrementalbasedir=/backup1/dir1
            #新版xtrabackup使用--target-dir指定增量备份的目录和--incrementalbasedir指定全量备份或增量备份的目录
    3.全量备份的&quot;prepare&quot;过程
        ~]# xtrabackup --prepare --target-dir=/backups/ 
            #新版xtrabackup使用--prepare和--target-dir进行&quot;prepare&quot;过程
    4.增量备份的&quot;prepare&quot;准备过程
        1.增量备份中的全量备份&quot;prepare&quot;过程
            ~]# xtrabackup --prepare --apply-log-only --target-dir=/backup1/dir1
            #新版xtrabackup的增量备份中的全量备份是使用--apply-log-only选项代替innobackupex中的--redo-only确保数据一致，提交完成的事务，回滚未完成的事务的;
        2.增量备份合并到全量备份：
            ~]# xtrabackup --prepare --apply-log-only --target-dir=/backup2/dir2 --incremental-dir=/backup1/dir1
            #要注意的是最后一个增量备份合并到全量备份时是不需要再加--apply-log-only选项的;
    5.还原：
        ~]# xtrabackup --copy-back --target-dir=/backup1/dir1
            #新版和旧版都是使用--copy-back选项只是使用命令的不同而已;
注意：
    1.跨完全备份和增量备份的事务，除了最后一个增量，其他的事务都不能回滚，最后一个才能回滚；
    2.如果最后一个增量备份也做redo-only或--apply-log-only可能会有问题，因为有些未提交的事务会没有回滚，但是这也没关系，因为msyql或mariadb启动时自己会将未提交的事务进行回滚的；
</code></pre>
      
    </div>

    

    
    
    

<div>
  
      <div>
    
        <div style="text-align:center;color: #FF0000;font-size:16px;">-------------------码字不易<i class="fa fa-heart"></i>尊重原创<i class="fa fa-heart"></i>转载标注<i class="fa fa-heart"></i>不胜感激-------------------</div>
    
</div>
  
</div>
<div>
      
        
      
</div>
    

    
       
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Coffee or Tea？</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="空腹吃早餐 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="空腹吃早餐 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/18/Kubernetes-Calico原理详解/" rel="next" title="Kubernetes-Calico原理详解">
                <i class="fa fa-chevron-left"></i> Kubernetes-Calico原理详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/23/MySQL-备份和恢复工具之Mysqldump/" rel="prev" title="MySQL-备份和恢复工具之Mysqldump">
                MySQL-备份和恢复工具之Mysqldump <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">
      
      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/haha.gif" alt="空腹吃早餐">
            
              <p class="site-author-name" itemprop="name">空腹吃早餐</p>
              <p class="site-description motion-element" itemprop="description">如果你也喜欢杰伦那我们就是好朋友 C'est la vie</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">57</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:liukui_work@163.com" title="E-Mail &rarr; mailto:liukui_work@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/a723bf5483d7" title="简书 &rarr; https://www.jianshu.com/u/a723bf5483d7" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/2879352237/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo &rarr; https://weibo.com/2879352237/profile?rightmod=1&wvr=6&mod=personinfo" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://music.163.com/#/user/home?id=321895687" title="CloudMusic &rarr; https://music.163.com/#/user/home?id=321895687" rel="noopener" target="_blank"><i class="fa fa-fw fa-music"></i>CloudMusic</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shuinoo.github.io/" title="https://shuinoo.github.io/" rel="noopener" target="_blank">蔡shuishui</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://litten.me/" title="http://litten.me/" rel="noopener" target="_blank">litten</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jysperm.me/" title="https://jysperm.me/" rel="noopener" target="_blank">Mr wang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ephen.me/" title="https://ephen.me/" rel="noopener" target="_blank">Ephen</a>
                  </li>
                
              </ul>
            </div>
          
          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Xtrabackup"><span class="nav-number">1.</span> <span class="nav-text">Xtrabackup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-xtrabackup基础"><span class="nav-number">2.</span> <span class="nav-text">1.xtrabackup基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-xtrabackup安装和常用备份参数选项"><span class="nav-number">3.</span> <span class="nav-text">2.xtrabackup安装和常用备份参数选项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-xtrabackup全量备份及恢复"><span class="nav-number">3.1.</span> <span class="nav-text">2.1.xtrabackup全量备份及恢复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-xtrabackup增量备份及恢复"><span class="nav-number">3.2.</span> <span class="nav-text">2.2.xtrabackup增量备份及恢复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-xtrabackup单表导出和导入功能"><span class="nav-number">4.</span> <span class="nav-text">3.xtrabackup单表导出和导入功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新增内容：4-新版xtrabackup和旧版xtrabackup备份和还原的区别"><span class="nav-number">5.</span> <span class="nav-text">新增内容：4.新版xtrabackup和旧版xtrabackup备份和还原的区别</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

      <div style="">
  <canvas id="canvas" style="width:70%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">空腹吃早餐</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">1.4m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">21:04</span>
  
</div>









<!-- 网站运行时间的设置 -->
<center>
    <font size="3" color="#FF0000">Coool's Blog已运行:<span id="run_time" style="color:#DB70DB"></span></font>  Sometimes your whole life boils down to one insame move.
</center>

<script>
    function runTime() {
        var d = new Date(),str = '';
        BirthDay=new Date("Nov 18,2017");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        str = ""+daysold+"天";
        str += d.getHours()+'时'; 
        str  += d.getMinutes()+'分'; 
        str+= d.getSeconds()+'秒'; 
        return str;
    }
    setInterval(function(){$('#run_time').html(runTime())},1000);
</script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="255,0,0" opacity="1" zindex="-1" count="230" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="/js/src/Valine.min.js"></script>

  <!-- https://deserts.io/diy-a-comment-system/ -->
  <script type="text/javascript">
    new Valine({
        lang: 'zh-cn',
        admin_email: '645150765@qq.com', //博主邮箱
        el: '#comments' ,
        appId: 'vk3KaAky0698trITaDye8Tul-gzGzoHsz',
        appKey: '3KISEUBblfzGHUAGvFxJvEyo',
        emoticon_url: 'https://cloud.panjunwen.com/alu',
        emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
        placeholder: '帅的人已经评论',
  });

  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>