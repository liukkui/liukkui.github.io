<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "ca4015c6"
    });
  daovoice('update');
  </script>

  <meta name="description" content="缓存基础介绍">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="redis基础">
<meta property="og:url" content="https://www.liukui.tech/2018/06/26/redis基础/index.html">
<meta property="og:site_name" content="Coool&#39;s Blog">
<meta property="og:description" content="缓存基础介绍">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.liukui.tech/2018/06/26/redis基础/用户请求CDN的流程.png">
<meta property="og:image" content="https://www.liukui.tech/2018/06/26/redis基础/分布式缓存架构.png">
<meta property="og:updated_time" content="2019-05-24T14:42:47.926Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis基础">
<meta name="twitter:description" content="缓存基础介绍">
<meta name="twitter:image" content="https://www.liukui.tech/2018/06/26/redis基础/用户请求CDN的流程.png">






  <link rel="canonical" href="https://www.liukui.tech/2018/06/26/redis基础/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>redis基础 | Coool's Blog</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">
<!-- 音频播放 -->
<script src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://myhkw.cn/player/js/player.js" id="myhk" key="159888076870" m="1"></script>
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Coool's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">As we watch our love grow.</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-address-card"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">30</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">36</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">75</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  


</div>
    </header>

    <a href="https://github.com/liukkui" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub">
      <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
      </svg>
      </a>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.liukui.tech/2018/06/26/redis基础/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="空腹吃早餐">
      <meta itemprop="description" content="如果你也喜欢杰伦那我们就是好朋友 C'est la vie">
      <meta itemprop="image" content="/images/haha.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coool's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redis基础
              
            
          </h1>
        

        <div class="post-meta">
                  
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-26 08:00:00" itemprop="dateCreated datePublished" datetime="2018-06-26T08:00:00+08:00">2018-06-26</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Nosql/" itemprop="url" rel="index"><span itemprop="name">Nosql</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Nosql/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/26/redis基础/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/06/26/redis基础/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">34k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">31 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="缓存基础介绍"><a href="#缓存基础介绍" class="headerlink" title="缓存基础介绍"></a>缓存基础介绍</h3><a id="more"></a>
<h3 id="1-系统缓存：buffer与cache"><a href="#1-系统缓存：buffer与cache" class="headerlink" title="1.系统缓存：buffer与cache"></a>1.系统缓存：buffer与cache</h3><pre><code>centos6是分开的，centos7放到一起了.
buffer：
    缓冲也叫写缓冲，一般用于写操作，可以将数据先写入内存再写入磁盘，buffer 一般用于写缓冲，用于解决不同介质
    的速度不一致的缓冲，先将数据临时写入到里自己最近的地方，以提高写入速度，CPU会把数据线写到内存的磁盘缓冲
    区，然后就认为数据已经写入完成看，然后内核的线程在后面的时间在写入磁盘，所以服务器突然断电会丢失内存中的
    部分数据。
    buffer是在内存中还没写到磁盘上，即将写到磁盘上的数据！
cache：
    缓存也叫读缓存，一般用于读操作，CPU读文件从内存读，如果内存没有就先从硬盘读到内存再读到CPU，将需要频繁读
    取的数据放在里自己最近的缓存区域，下次读取的时候即可快速读取。
    cache是vim/cat等打开的文件信息放到内存中的称为cache,是为了下次访问时加速的！
cache的保存位置：
    客户端：浏览器(每个浏览器的默认过期时间不一样)
    内存：本地服务器、远程服务器
    硬盘：本机硬盘、远程服务器硬盘
    速度对比：
    客户端浏览器-CPU-内存-远程内存-硬盘-远程硬盘。
cache的特性:
    1.过期时间
    2.强制过期，源网站更新图片后CDN是不会更新的，需要强制是图片缓存过期
    3.命中率，即缓存的读取命中率
        在memcached中可以看到有多少缓存和缓存的命中率;

Cache（缓存）位于CPU与内存之间的临时存储器，缓存容量比内存小的多但交换速度比内存要快得多。Cache通过缓存文件
数据块，解决CPU运算速度与内存读写速度不匹配的矛盾，提高CPU和内存之间的数据交换速度。Cache缓存越大，CPU处理速
度越快。

Buffer（缓冲）高速缓冲存储器，通过缓存磁盘（I/O设备）数据块，加快对磁盘上数据的访问，减少
I/O，提高内存和硬盘（或其他I/O设备）之间的数据交换速度。Buffer是即将要被写入磁盘的，
而Cache是被从磁盘中读出来的。
</code></pre><h3 id="2-CDN缓存"><a href="#2-CDN缓存" class="headerlink" title="2.CDN缓存"></a>2.CDN缓存</h3><p><img src="/2018/06/26/redis基础/用户请求CDN的流程.png" alt="用户请求CDN的流程"></p>
<pre><code>CDN内容分发网络（Content Delivery Network），通过将服务内容分发至全网加速节点，利用全球调度系统使用户能够
就近获取，有效降低访问延迟，提升服务可用性.
    1.CDN第一降低机房的使用带宽，因为很多资源通过CDN就直接返回用户了;
    2.第二解决不同运营商之间的互联，因为可以让联通的网络访问联通让电信的网络访问电信，起到加速用户访问的目的;
    3.第三解决用户访问的地域问题，就近返回用户资源;

关于302调度：
    如用的是是联通的网络，但是设置了一个电信的DNS，或者电信的用户设置了一个联通的DNS，在刚建立连接的时候CDN法获
    取到用户的真实IP，而是只能获取到用户的local DNS而判定用户是联通还是电信的网络，假如设置了错误的运营商DNS会
    被调度到错误的CDN 边缘节点，当和边缘节点连接之后就可以获取到用户的真实IP从而判断用户是联通还是电信的网络，如
    果是电信的网络被调度到了联通的CDN边缘节点或者是电信的网络被调度到了联通的CND边缘节点，那么可以给用户再发送一
    个302重定向的回复，用户的浏览器再根据新的地址进行连接，即可访问到正确的CND 边缘节点。

用户请求CDN的流程：
    提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而导致数据无法更新，另外CDN可以将数据根
    据访问的热度不同而进行不同级别的缓存，例如访问量最高的资源访问CDN 边缘节点的内存，其次的放在SSD或者SATA，
    再其次的放在云存储，这样兼顾了速度与成本。

内容分发与分层：
    提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而导致数据无法更新，另外CDN可以将数据根
    据访问的热度不通而进行不通级别的缓存，例如访问量最高的资源访问CDN 边缘节点的内存，其次的放在SSD或者SATA，
    再其次的放在云存储，这样兼顾了速度与成本

CDN的主要优势：
    1.提前对静态内容进行预缓存，避免当地用户大量的请求回源，导致主站网络带宽被打满而导致数据无法更新,变向的
    减小了存储、Web服务器、数据库的压力；
    2.CDN还可以将数据根据访问的热度不通而进行不通级别的缓存，例如访问量最高的资源访问CDN边缘节点的内存，其次
    的放在SSD(经常访问的数据放到SSD)或者SATA(不经常访问的放到SATA)，再其次的放在云存储，这样兼顾了速度与成
    本。缓存-缓存到最快的地方如内存，缓存的数据准确命中率高，访问速度就快
    3.将用户准确调度到最近的边缘节点性能优化，加快访问速度;
    4.CDN还可以进行安全相关-抵御攻击
    5.最主要的还是节省带宽；

自建CDN优缺点：
    nginx+squid、nginx+varnish、nginx+ATS等方式可以自建
    优点：
        自建CDN 比较灵活，可以在访问用户较多的地方多部署服务器
        成本比较容易控制
    缺点：
        费用高
        团队技术要求高
        问题不变排查，出问题不容易搞的定 
</code></pre><h3 id="3-应用层缓存"><a href="#3-应用层缓存" class="headerlink" title="3.应用层缓存"></a>3.应用层缓存</h3><pre><code>Nginx、PHP、tomcat等web服务可以设置应用缓存以加速响应用户请求，另外有些解释性语言比如PHP/Python不能直接运行
，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候会出现程序代
码上线后字节码没有更新的现象。

动态页面静态化：
    将java的动态页面静态化，比如将每个具体产品的web页面静态化为html文件，然后通过nginx 的rewrite功能发布，
    即用户最终访问到的某个产品的web 页面是静态的页面，静态页面的访问速度是比较快的，生成的静态页面可以通过nfs、
    rsync、分布式存储等方式推送到各web服务器，如果静态页面生成的信息是错误的，可以将信息更改后通过推送平台重新生
    成新的web页面并同步到各web服务器，平时可以通过每间隔几个小时自动生成静态页面，比如每6小时生成一次动态页面并同步到各web服务器;
</code></pre><h3 id="4-其他缓存"><a href="#4-其他缓存" class="headerlink" title="4.其他缓存"></a>4.其他缓存</h3><pre><code>CPU缓存(L1的数据缓存和L1的指令缓存)、二级缓存、三级缓存
磁盘缓存
RAID卡缓存
分布式缓存：redis、memcache 
# MegaCli64 -LDinfo -Lall -aAll 此命令可以监控到物理机的raid、磁盘等信息
</code></pre><h3 id="Redis和Memcached"><a href="#Redis和Memcached" class="headerlink" title="Redis和Memcached"></a>Redis和Memcached</h3><p><img src="/2018/06/26/redis基础/分布式缓存架构.png" alt="分布式缓存架构"></p>
<pre><code>1.Redis和Memcached是非关系型数据库也称为NoSQL，
2.redis是一个开源的、遵循BSD协议的、基于内存的而且目前比较流行的键值数据库(key-value database)，是一个非关
系型数据库，redis提供将内存通过网络远程共享的一种服务，提供类似功能的还有memcache，但相比memcache，redis还
提供了易扩展、高性能、具备数据持久性等功能；
3.redis是单线程的，在高并发、低延迟环境要求比较高的环境使用量非常广泛，memcached是多进程的.

redis和memcached的对比：
    1.支持两种方式进行数据的持久化：可以将内存中的数据保持在磁盘中，重启redis服务或者服务器之后可以从备份文
    件中恢复数据到内存继续使用。
    2.支持更多的数据类型：支持string(字符串)、hash(哈希数据)、list(列表)、set(集合)、zet(有序集合)
    3.支持数据的备份：可以实现类似于数据的master-slave模式的数据备份，另外也支持使用快照+AOF；
    4.支持更大的value数据：memcache单个key value最大只支持1MB，而redis最大支持
    512MB；
    5.Redis 是单线程，而memcache是多线程，所以单机情况下没有memcache并发高，但redis 
        支持分布式集群以实现更高的并发，单Redis实例可以实现数万并发。
    6.支持集群横向扩展：基于redis cluster的横向扩展，可以实现分布式集群，大幅提
    升性能和数据安全性。
    7.都是基于C语言开发。

redis的典型应用场景：
    Session共享：常见于web集群中的Tomcat或者PHP中多web服务器session共享
            详见：tomcat的session cluster/server共享
    消息队列：ELK的日志缓存、部分业务的订阅发布系统
    计数器：访问排行榜、商品浏览数等和次数相关的场景
    缓存：数据查询、电商网站商品信息、新闻内容
    微博/微信社交场合：共同好友、点赞评论等

redis的主要功能：
    1.Redis支持多种数据结构，包括字符串、哈希表、链表、集合、有序集合、位图、Hyperloglogs等;
    2.Redis具备LRU淘汰、事务实现、以及不同级别的硬盘持久化等能力，并且支持副本集和
    通过Redis Sentinel实现的高可用方案，同时还支持通过Redis Cluster实现的数
    据自动分片能力;
    3.Redis的主要功能都基于单线程模型实现，也就是说Redis使用一个线程来服务所有的
    客户端请求，同时Redis采用了非阻塞式IO，并精细地优化各种命令的算法时间复杂度，
    这些信息意味着：
        1.Redis是线程安全的（因为只有一个线程），其所有操作都是原子的，不会因并发产生数据异常;
        2.Redis的速度非常快（因为使用非阻塞式IO，且大部分命令的算法时间复杂度都是O(1));
        3.使用高耗时的Redis命令是很危险的，会占用唯一的一个线程的大量处理时间，导致所有的请求都被拖慢。
        （例如时间复杂度为O(N)的KEYS命令，严格禁止在生产环境
        中使用);
</code></pre><h3 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h3><pre><code>版本：
    公司现在一般用的是3.X 4.X版本的，最新是5.3版本了
    http://download.redis.io/releases/
    epel源上的redis版本是3.2.12，这里进行编译安装redis-5.0.3版本；
编译安装：
    [root@node01 ~]# cd /usr/local/src
    [root@node01 src]# tar xf redis-5.0.3.tar.gz 
    [root@node01 src]# cd redis-5.0.3
    [root@node01 redis-5.0.3]# make PREFIX=/usr/local/redis install 
        #将二进制命令放到/usr/local/redis下
        编译安装的就不能使用systemctl进行启动了，可以根据yum安装的程序路径进行修改；
    [root@node01 redis]# mkdir /usr/local/redis/etc/   #创建配置文件目录
    [root@node01 redis]# mkdir /usr/local/redis/data/  #创建数据目录
    [root@node01 redis]# mkdir /usr/local/redis/logs/  #创建日志存放目录
    [root@node01 redis]# mkdir /usr/local/redis/run/   ##创建pid目录
    [root@node01 redis]# cp /usr/local/src/redis-5.0.3/redis.conf /usr/local/redis/etc/
        #将原来目录下的redis.conf文件拷贝到二进制命令的目录下
redis相关命令:
    [root@node01 bin]# ll
    total 32672
    -rwxr-xr-x. 1 root root 4366608 Mar 10 03:28 redis-benchmark
    -rwxr-xr-x. 1 root root 8090040 Mar 10 03:28 redis-check-aof
            #用于检查aof文件异常状态
    -rwxr-xr-x. 1 root root 8090040 Mar 10 03:28 redis-check-rdb
            #用于检查rbd文件异常状态
    -rwxr-xr-x. 1 root root 4801864 Mar 10 03:28 redis-cli
            #redis客户端命令
    lrwxrwxrwx. 1 root root      12 Mar 10 03:28 redis-sentinel -&gt; redis-server  #哨兵命令
    -rwxr-xr-x. 1 root root 8090040 Mar 10 03:28 redis-server
            #redis主程序用于启动redis
启动：
    [root@node01 redis]# pwd
    /usr/local/redis
    [root@node01 redis]# /usr/local/redis/bin/redis-server etc/redis.conf 
        #启动后会有三个警告信息一定要修改，不然运行后期会有错误

解决启动时三个报警信息：
    1.backlog参数控制的是三次握手的时候server端收到client ack确认号之后的队列值。
        net.core.somaxconn = 512
    2.vm.overcommit_memory：
        0 表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存
        申请失败，并把错误返回给应用进程。
        1 表示内核允许分配所有的物理内存，而不管当前的内存状态如何。
        2 表示内核允许分配超过所有物理内存和交换空间总和的内存
        vm.overcommit_memory = 1
        #因为memcached和redis是直接操作内存的，内存的参数不需要使用内核的参数来调了;
    3.transparent hugepage：
        开启大页内存动态分配，需要关闭让redis 负责内存管理。
        echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
        #如果是虚拟化的情况下，需要打开；

修改配置文件并开机自动生效：
    [root@node01 etc]# vim /etc/rc.d/rc.local
    echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
    [root@node01 etc]# chmod +x /etc/rc.d/rc.local
    [root@node01 etc]# vim /etc/sysctl.conf
    net.core.somaxconn = 512
    vm.overcommit_memory = 1

创建用户：
    [root@node01 redis]# useradd redis -s /sbin/nologin
设置目录权限：
    [root@node01 redis]# chown redis.redis /usr/local/redis/ -R
    #redis用户要对编译的路径有权限
创建软链接：
    [root@node01 bin]# ln -sv /usr/local/redis/bin/redis-* /usr/sbin/

编辑redis服务启动脚本:
    # cat  /usr/lib/systemd/system/redis.service
    [Unit]
    Description=Redis persistent key-value database
    After=network.target
    After=network-online.target
    Wants=network-online.target

    [Service]
    ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf  --supervised systemd
    ExecReload=/bin/kill -s HUP $MAINPID 
    ExecStop=/bin/kill -s QUIT $MAINPID
    Type=notify
    User=redis
    Group=redis
    RuntimeDirectory=redis
    RuntimeDirectoryMode=0755

    [Install]
    WantedBy=multi-user.target
启动：
    systemctl start redis
</code></pre><h3 id="Redis配置文件详解"><a href="#Redis配置文件详解" class="headerlink" title="Redis配置文件详解"></a>Redis配置文件详解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">登录：</span><br><span class="line">    [root@node01 bin]# redis-cli  -h host (设置了bind就需要指定IP地址)</span><br><span class="line">        info    #查看redis信息</span><br><span class="line">        select  #切换数据库，默认是16个库(编号0-15)</span><br><span class="line">redis配置文件主要配置项：</span><br><span class="line">######################## 网络配置项  #####################################</span><br><span class="line">bind 0.0.0.0 #监听地址，可以用空格隔开后多个监听IP</span><br><span class="line">    #一般只监听在redis服务器的内网IP上,redis强烈建议内网使用</span><br><span class="line">protected-mode yes  redis的保护模式</span><br><span class="line">    #redis3.2之后加入的新特性，在没有设置bind IP和密码的时候只允许访问</span><br><span class="line">    127.0.0.1:6379</span><br><span class="line">port 6379       #监听端口</span><br><span class="line">tcp-backlog 511 #三次握手的时候server端收到client ack确认号被占满后的等待队列</span><br><span class="line">                长度；</span><br><span class="line">timeout 0 </span><br><span class="line">    #客户端和Redis服务端的连接超时时间，默认是0，表示永不超时，生产环境下是600。 </span><br><span class="line">tcp-keepalive 300   #tcp会话保持超时时间</span><br><span class="line">########################### 通用配置项 ################################</span><br><span class="line">daemonize no    #默认情况下redis不是作为守护进程运行的，如果你想让它在后台</span><br><span class="line">        运行，你就把它改成yes,当redis作为守护进程运行的时候，它会写一个pid</span><br><span class="line">        到/var/run/redis.pid文件里面；</span><br><span class="line">        在centos6上是yes，在centos7上都是no</span><br><span class="line">supervised no </span><br><span class="line">        #和操作系统相关参数，可以设置通过upstart和systemd管理Redis守护进程，</span><br><span class="line">        centos 7以后都使用systemd</span><br><span class="line">pidfile /usr/local/redis/redis_6379.pid #pid文件路径</span><br><span class="line">        #一般习惯放在编译的路径下(但是redis用户需要对此目录有读权限)</span><br><span class="line">loglevel notice     #日志级别</span><br><span class="line">#loglevel debug  #如果日志显示不详细，可以开启debug模式，但是debug的日志会很大；</span><br><span class="line">logfile &quot;/usr/local/redis/redis_6379.log&quot; #日志路径</span><br><span class="line">    #一般习惯放在编译的路径下(但是redis用户需要对此目录有读权限)</span><br><span class="line">databases 16  #设置db库数量，默认16个库，名称编号0-15</span><br><span class="line">            改成-1,表示支持无限个库</span><br><span class="line">####################### 和快照相关的参数/RBD ###############################</span><br><span class="line">###快照时从redis主进程复制出一个专门的进程做快照，不会影响redis的读写</span><br><span class="line">always-show-logo yes #在启动redis 时是否显示log</span><br><span class="line">save 900 1  #在900秒内有一个键内容发生更改就出就快照机制</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000  #也可以通过BGSAVE命令手工触发RDB快照保存。</span><br><span class="line">    #注意这是逆向生效的，启动一次全量备份</span><br><span class="line">    表示：三个策略满足其中任意一个均会触发SNAPSHOTTING操作；60s内至少有1W次key发生变化才触发备份，300s内至少</span><br><span class="line">    有10次key有变化才触发备份，900s内至少有一次key有变化，所以最迟是900s/15min分钟会做一次快照全量备份；</span><br><span class="line">stop-writes-on-bgsave-error no  #快照创建出错时是否禁止redis写入操作</span><br><span class="line">    #重要配置，一定要改成no,避免快照因为磁盘空间满了快照写不进去，使得redis</span><br><span class="line">    无法登陆；</span><br><span class="line">rdbcompression yes #持久化到RDB文件时，是否压缩，&quot;yes&quot;为压缩，&quot;no&quot;则反之</span><br><span class="line">            #启用压缩功能有时还是有必要的</span><br><span class="line">rdbchecksum yes  #是否开启RC64校验，默认是开启</span><br><span class="line">dbfilename dump.rdb #快照生成的文件名，一般给称redis_6379.rdb</span><br><span class="line">dir ./ #快照文件保存路径;一般放在二进制编译路径下/usr/loca/redis</span><br><span class="line">        #一般这个路径不会放在系统盘的而是放在数据盘/挂载存储</span><br><span class="line">        #像k8s中这个盘可能是放在ceph/nfs/glusterfs上的,即使云服务down，</span><br><span class="line">        也会自动启动一个容器/pod加载到这个盘和文件进行数据恢复</span><br><span class="line">##################### REPLICATION主从复制相关的参数####################</span><br><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;  #修改为master的IP和端口</span><br><span class="line">    如：replicaof 192.168.34.118 6379</span><br><span class="line">masterauth &lt;master-password&gt;       #master的密码</span><br><span class="line">replica-serve-stale-data yes    #当主节点down了，是否使用过期数据提供给主节点</span><br><span class="line">replica-read-only yes           #作为从服务器必须要是只读的</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">    no, Disk-backed, Diskless</span><br><span class="line">        新的从节点或某较长时间未能与主节点进行同步的从节点重新与主节点通信，需要做&quot;full synchronization&quot;，此时其同步方式有两种style：</span><br><span class="line">            Disk-backend：主节点新创建快照文件于磁盘中，而后将其发送给从节点；</span><br><span class="line">            Diskless：主节占新创建快照后直接通过网络套接字文件发送给从节点；为了实现并行复制，通常需要在复制启动前延迟一个时间段；</span><br><span class="line">repl-diskless-sync-delay 5  #Diskless模式下复制启动前延迟一个时间</span><br><span class="line">        #在第一个从节点连进来后等待5s，在这5s内其他从节点都连进来之后</span><br><span class="line">        主节点主做一次复制同时传给N个从节点，加快效率</span><br><span class="line">repl-ping-replica-period 10 #默认不开启</span><br><span class="line">    #slave端向server端发送ping的时间区间设置，默认为10秒</span><br><span class="line">repl-timeout 60  </span><br><span class="line">    #设置复制的超时时长，60s,超过这个时间，从节点再连到主节点就需要重新复制了；</span><br><span class="line">repl-disable-tcp-nodelay no  #不禁止tcp nodelay，也就是启用tcp nodelay</span><br><span class="line">replica-priority 100  #从节点的优先级</span><br><span class="line">    复制集群中，主节点故障时，sentinel应用场景中的主节点选举时使用的优先级；数字越小优先级越高，但0表示不参与选举； </span><br><span class="line">    #类似于keepalived的主从priority</span><br><span class="line">min-slaves-to-write 3</span><br><span class="line">        #主节点仅允许其能够通信的从节点数量大于等于此处的值时接受写操作；</span><br><span class="line">min-slaves-max-lag 10</span><br><span class="line">        #从节点延迟时长超出此处指定的时长时，主节点会拒绝写入操作；10s</span><br><span class="line">####################和安全相关的参数配置####################################</span><br><span class="line">requirepass root123456   #设置redis的登录密码</span><br><span class="line">    登录后，需要AUTH root23456验证后，才能set key</span><br><span class="line">    如果不设置密码，通过telnet就可以登录到redis进行删除等操作，所以生产环境下建议一定要设置密码.</span><br><span class="line">################# 和客户端相关的参数配置/limits #############################</span><br><span class="line">maxclients 10000    #最大的客户端并发连接数</span><br><span class="line">        #默认值就可以了，毕竟redis是面向应用程序服务器的，而不是客户端</span><br><span class="line">############### 内存管理与数据淘汰机制/极其重要 ##############################</span><br><span class="line">maxmemory 8589934592   #单位是字节(8g*1024*1024*1024)</span><br><span class="line">        #一旦设置了最大使用内存空间，当使用空间耗尽时，就需要定义策略了；</span><br><span class="line">        #注意一定要设置最大内存，如果不设置可能会启用swap交换内存,交换内存会降低</span><br><span class="line">        redis的性能，而且swap也使用完后就会导致OOM，内核会kill掉redis进程；</span><br><span class="line">maxmemory-policy noeviction  #默认使用的淘汰策略</span><br><span class="line">    1.volatile-lru  #对设置了过期时间的key使用LRU算法进行淘汰</span><br><span class="line">    2.allkeys-lru   #对所有键key使用LRU算法进行淘汰</span><br><span class="line">    3.volatile-random  #对过期的key进行随机算法进行淘汰</span><br><span class="line">    4.allkeys-random   #对所有键key基于随机算法进行淘汰</span><br><span class="line">    5.volatile-ttl  #比较设置了过期时间的key，越短的先被淘汰</span><br><span class="line">    6.noeviction    #不淘汰任何现有的数据项</span><br><span class="line">        #redis作为database时，一定要使用noeviction</span><br><span class="line">        #redis作为缓存时，应该使用volatile-lru或者noeviction，具体使用哪种策略取决于业务中的具体情况；</span><br><span class="line">配置解析：</span><br><span class="line">    1.默认情况下，在32位OS中，Redis最大使用3GB的内存，在64位OS中则没有限制。</span><br><span class="line">    2.在使用Redis时，应该对数据占用的最大空间有一个基本准确的预估，并为Redis设定最大使用的内存。否则在64位OS中</span><br><span class="line">    Redis会无限制地占用内存（当物理内存被占满后会使用swap空间），容易引发各种各样的问题；</span><br><span class="line">    3.在内存占用达到了maxmemory后，再向Redis写入数据时，Redis会：</span><br><span class="line">        1.根据配置的数据淘汰策略尝试淘汰数据，释放空间</span><br><span class="line">        2.如果没有数据可以淘汰，或者没有配置数据淘汰策略，那么Redis会对所有写请求返回错误，但读请求仍然可以正常执行</span><br><span class="line">    4.在为Redis设置maxmemory时，需要注意：</span><br><span class="line">        1.如果采用了Redis的主从同步，主节点向从节点同步数据时，会占用掉一部分内存空间，如果maxmemory过于接近</span><br><span class="line">        主机的可用内存，导致数据同步时内存不足。所以设置的maxmemory不要过于接近主机可用的内存，留出一部分预留用作主从同步。</span><br><span class="line">maxmemory-samples 5     #淘汰算法运行时的采样样本数；</span><br><span class="line">######################### AOF相关配置 #################################</span><br><span class="line">appendonly yes   #启用aof日志，类似于mysql的bin-log,一定要改成yes</span><br><span class="line">        #登录redis的select、Set等操作就会被记录在此日志中</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;  #aof日志的路径和名称</span><br><span class="line">        #注意这个路径是以上面的dir路径为根的</span><br><span class="line">        #如果要保存在一个后端存储上，最好写成绝对路径</span><br><span class="line">    -----------------------------------------------------------</span><br><span class="line">#AOF提供了三种fsync配置，always/everysec/no，通过配置项[appendfsync]指定：</span><br><span class="line">#appendfsync always  </span><br><span class="line">        #每写入一条日志就进行一次fsync操作，数据安全性最高，但速度最慢    </span><br><span class="line">appendfsync everysec</span><br><span class="line">        #折中的做法，交由后台线程每秒fsync一次</span><br><span class="line">#appendfsync no     </span><br><span class="line">        #不进行fsync，将flush文件的时机交给OS决定，速度最快</span><br><span class="line">    ----------------------------------------------------------</span><br><span class="line">#随着AOF不断地记录写操作日志，必定会出现一些无用的日志，例如某个时间点执行了命令SET key1 “abc”，在之后某个</span><br><span class="line">时间点又执行了SET key1 “bcd”，那么第一条命令很显然是没有用的。大量的无用日志会让AOF文件过大，也会让数据恢复的</span><br><span class="line">时间过长。</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb    #触发aof日志rewrite</span><br><span class="line">    #上面两行配置的含义是，Redis在每次AOF rewrite时，会记录完成rewrite后的AOF日志大小，当AOF日志大小在该基础</span><br><span class="line">    上增长了100%后，自动进行AOF rewrite。同时如果增长的大小没有达到64mb，则不会进行rewrite。</span><br><span class="line">############################# 慢日志查询相关配置 ##########################</span><br><span class="line">Slow log是Redis用来记录查询执行时间的日志系统，slow log保存在内存里面，读写</span><br><span class="line">速度非常快，因此你可以放心地使用它，不必担心因为开启slow log而损害Redis的速度。</span><br><span class="line">slowlog-log-slower-than 10000(10毫秒10的负6次方)</span><br><span class="line">        #以微秒为单位的慢日志记录，为负数会禁用慢日志，为0会记录每个命令操作</span><br><span class="line">slowlog-max-len 128   </span><br><span class="line">        #记录多少条慢日志保存在队列，超出后会删除最早的，以此滚动删除</span><br><span class="line">####################### REDIS CLUSTER集群相关 ##############################</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">    #集群节点集群信息配置文件,每个节点都有一个,由redis生成和更新,配置时避免名称冲突</span><br><span class="line">    #直接指一个文件名即可，文件内容自动生成不需要填入任何配置参数</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">    集群节点互连超时的阈值，单位毫秒</span><br><span class="line">cluster-slave-validity-factor 10</span><br><span class="line">    进行故障转移时,salve会申请成为master。有时slave会和master失联很久导致数据较旧，这样的slave不应该成为</span><br><span class="line">    master。这个配置用来判断slave是否和master失联时间过长。</span><br><span class="line">###########################################################################</span><br></pre></td></tr></table></figure>
<h3 id="Redis的数据结构和常用命令"><a href="#Redis的数据结构和常用命令" class="headerlink" title="Redis的数据结构和常用命令"></a>Redis的数据结构和常用命令</h3><pre><code>Key:
1.Redis采用Key-Value型的基本数据结构，任何二进制序列都可以作为Redis的Key使用（例如普通的字符串或一张JPEG图片）
2.关于Key的一些注意事项：
    1.不要使用过长的Key。例如使用一个1024字节的key就不是一个好主意，不仅会消耗更多的内存，还会导致查找的效率降低
    2.Key短到缺失了可读性也是不好的，例如”u1000flw”比起”user:1000:followers”来说，节省了寥寥的存储空间，却引发了可读性和可维护性上的麻烦
    3.最好使用统一的规范来设计Key，比如”object-type:id:attr”，以这一规范设计出的Key可能是”user:1000″或
    ”comment:1234:reply-to”
    4.Redis允许的最大Key长度是512MB（对Value的长度限制也是512MB）
</code></pre><h4 id="1-字符串-String"><a href="#1-字符串-String" class="headerlink" title="1.字符串:String"></a>1.字符串:String</h4><pre><code>1.String是Redis的基础数据类型，Redis没有Int、Float、Boolean等数据类型的概念，所有的基本类型在Redis中都以String体现;
    SET：为一个key设置value，可以配合EX/PX参数指定key的有效期，通过NX/XX参数针对
        key是否存在的情况进行区别操作，时间复杂度O(1)
    GET：获取某个key对应的value，时间复杂度O(1)
    GETSET：为一个key设置value，并返回该key的原value，时间复杂度O(1)
    MSET：为多个key设置value，时间复杂度O(N)
    MSETNX：同MSET，如果指定的key中有任意一个已存在，则不进行任何操作，时间复杂度O(N)
    MGET：获取多个key对应的value，时间复杂度O(N)
2.redis的基本数据类型只有String，但Redis可以把String作为整型或浮点型数字来使用，主要体现在INCR、DECR类的命令上：
    1.INCR：将key对应的value值自增1，并返回自增后的值。只对可以转换为整型的String
        数据起作用。时间复杂度O(1)
    2.INCRBY：将key对应的value值自增指定的整型数值，并返回自增后的值。只对可以转换
        为整型的String数据起作用。时间复杂度O(1)
    3.DECR/DECRBY：同INCR/INCRBY，自增改为自减。
备注：
    1.INCR/DECR系列命令要求操作的value类型为String，并可以转换为64位带符号的整型
        数字，否则会返回错误。
    2.也就是说，进行INCR/DECR系列命令的value，必须在[-2^63 ~ 2^63 – 1]范围内。
    3.前文提到过，Redis采用单线程模型，天然是线程安全的，这使得INCR/DECR命令可以
        非常便利的实现高并发场景下的精确控制。
例1：库存控制
    在高并发场景下实现库存余量的精准校验，确保不出现超卖的情况。
    设置库存总量：
        SET inv:remain &quot;100&quot; 
    库存扣减+余量校验：
        DECR inv:remain
    当DECR命令返回值大于等于0时，说明库存余量校验通过，如果返回小于0的值，则说明库存已耗尽。
    假设同时有300个并发请求进行库存扣减，Redis能够确保这300个请求分别得到99到-200的返回值，每个请求得到的
    返回值都是唯一的，绝对不会找出现两个请求得到一样的返回值的情况。

例2：自增序列生成
    实现类似于RDBMS的Sequence功能，生成一系列唯一的序列号
    设置序列起始值：
        SET sequence &quot;10000&quot; 
    获取一个序列值：
        INCR sequence      
    直接将返回值作为序列使用即可；

    获取一批（如100个）序列值：
        INCRBY sequence 100     
    假设返回值为N，那么[N – 99 ~ N]的数值都是可用的序列值。
    当多个客户端同时向Redis申请自增序列时，Redis能够确保每个客户端得到的序列值或序
        列范围都是全局唯一的，绝对不会出现不同客户端得到了重复的序列值的情况。
</code></pre><h4 id="2-列表：和ELK相关，基于管道插入多个数据"><a href="#2-列表：和ELK相关，基于管道插入多个数据" class="headerlink" title="2.列表：和ELK相关，基于管道插入多个数据"></a>2.列表：和ELK相关，基于管道插入多个数据</h4><pre><code>Redis的List是链表型的数据结构，可以使用LPUSH/RPUSH/LPOP/RPOP等命令在List的两端执行插入元素和弹出元素的
操作。虽然List也支持在特定index上插入和读取元素的功能，但其时间复杂度较高（O(N)），应小心使用；

    1.LPUSH：向指定List的左侧（即头部）插入1个或多个元素，返回插入后的List长度。
        时间复杂度O(N)，N为插入元素的数量
    2.RPUSH：同LPUSH，向指定List的右侧（即尾部）插入1或多个元素
    3.LPOP：从指定List的左侧（即头部）移除一个元素并返回，时间复杂度O(1)
    4.RPOP：同LPOP，从指定List的右侧（即尾部）移除1个元素并返回
    5.LPUSHX/RPUSHX：与LPUSH/RPUSH类似，区别在于，LPUSHX/RPUSHX操作的key
        如果不存在，则不会进行任何操作
    6.LLEN：返回指定List的长度，时间复杂度O(1)
    7.LRANGE：返回指定List中指定范围的元素（双端包含，即LRANGE key 0 10会返回
        11个元素），时间复杂度O(N)。应尽可能控制一次获取的元素数量，一次获取过大范
        围的List元素会导致延迟，同时对长度不可预知的List，避免使用LRANGE key 0 -1这样的完整遍历操作。

应谨慎使用的List相关命令：
    1.LINDEX：返回指定List指定index上的元素，如果index越界，返回nil。index数值是
        回环的，即-1代表List最后一个位置，-2代表List倒数第二个位置。时间复杂度O(N)
    2.LSET：将指定List指定index上的元素设置为value，如果index越界则返回错误，
        时间复杂度O(N)，如果操作的是头/尾部的元素，则时间复杂度为O(1)
    3.LINSERT：向指定List中指定元素之前/之后插入一个新元素，并返回操作后的List长
        度。如果指定的元素不存在，返回-1。如果指定key不存在，不会进行任何操作，时间复杂度O(N)

由于Redis的List是链表结构的，上述的三个命令的算法效率较低，需要对List进行遍历，
    命令的耗时无法预估，在List长度大的情况下耗时会明显增加，应谨慎使用。

换句话说，Redis的List实际是设计来用于实现队列，而不是用于实现类似ArrayList这样的
列表的。如果你不是想要实现一个双端出入的队列，那么请尽量不要使用Redis的List数据结构
</code></pre><h4 id="3-集合-Set"><a href="#3-集合-Set" class="headerlink" title="3.集合:Set"></a>3.集合:Set</h4><pre><code>Redis Set是无序的，集合成员是唯一的，不可重复的String集合.
与Set相关的常用命令：
    1.SADD：向指定Set中添加1个或多个member，如果指定Set不存在，会自动创建一个。
        时间复杂度O(N)，N为添加的member个数
    2.SREM：从指定Set中移除1个或多个member，时间复杂度O(N)，N为移除的member个数
    3.SRANDMEMBER：从指定Set中随机返回1个或多个member，时间复杂度O(N)，N为返回的
        member个数;
    4.SPOP：从指定Set中随机移除并返回count个member，时间复杂度O(N)，N为移除的
        member个数;
    5.SCARD：返回指定Set中的member个数，时间复杂度O(1)
    6.SISMEMBER：判断指定的value是否存在于指定Set中，时间复杂度O(1)
    7.SMOVE：将指定member从一个Set移至另一个Set   
        SADD set1 v1            #生成集合key
        TYPE set1               #查询集合key
        SADD set1 v2 v3 v4      #追加数值，追加的时候不能追加已经存在的数值
        SMEMBERS set1           #查看集合的所有数据
        SDIFF set1 set2         #获取集合的差集
            #差集：已属于A而不属于B的元素称为A与B的差（集）
        SINTER set1 set2        #获取集合的交集
            #交集：已属于A且属于B的元素称为A与B的交（集）
        SUNION  set1 set2       #获取集合的并集
            #并集：已属于A或属于B的元素为称为A与B的并（集）
慎用的Set相关命令：
    1.SMEMBERS：返回指定Hash中所有的member，时间复杂度O(N)
    2.SUNION/SUNIONSTORE：计算多个Set的并集并返回/存储至另一个Set中，时间复杂度O(N)，N为参与计算的所有集合的总member数
    3.SINTER/SINTERSTORE：计算多个Set的交集并返回/存储至另一个Set中，时间复杂度O(N)，N为参与计算的所有集合的总member数
    4.SDIFF/SDIFFSTORE：计算1个Set与1或多个Set的差集并返回/存储至另一个Set中，时间复杂度O(N)，N为参与计算的所有集合的总member数
上述几个命令涉及的计算量大，应谨慎使用，特别是在参与计算的Set尺寸不可知的情况下，应严格避免使用
</code></pre><h4 id="4-有序集合：sorted-set"><a href="#4-有序集合：sorted-set" class="headerlink" title="4.有序集合：sorted set"></a>4.有序集合：sorted set</h4><pre><code>1.Sorted Set非常适合用于实现排名。
2.Redis Sorted Set和Set一样也是string类型元素的集合,且不允许重复的成员，不同的是
    Sorted Set中的每个元素都会关联一个double(双精度浮点型)类型的分数(score)，Sorted Set会根据score对元素
    进行升序排序。如果多个member拥有相同的score，则以字典序进行升序排序;序集合的成员是唯一的,但分数(score)
    却可以重复，集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)，集合中最大的成员数为 232 
    - 1 (4294967295, 每个集合可存储40多亿个成员);
Sorted Set的主要命令：
    1.ZADD：向指定Sorted Set中添加1个或多个member，时间复杂度O(Mlog(N))，M为添加的member数量，N为Sorted Set中的member数量
    2.ZREM：从指定Sorted Set中删除1个或多个member，时间复杂度O(Mlog(N))，M为删除的member数量，N为Sorted Set中的member数量
    3.ZCOUNT：返回指定Sorted Set中指定score范围内的member数量，时间复杂度：O(log(N))
    4.ZCARD：返回指定Sorted Set中的member数量，时间复杂度O(1)
    5.ZSCORE：返回指定Sorted Set中指定member的score，时间复杂度O(1)
    6.ZRANK/ZREVRANK：返回指定member在Sorted Set中的排名，ZRANK返回按升序排序的排名，ZREVRANK则
        返回按降序排序的排名。时间复杂度O(log(N))
    7.ZINCRBY：同INCRBY，对指定Sorted Set中的指定member的score进行自增，
    时间复杂度O(log(N));
慎用的Sorted Set相关命令：
    1.ZRANGE/ZREVRANGE：返回指定Sorted Set中指定排名范围内的所有member，ZRANGE为按score升序排序，
        ZREVRANGE为按score降序排序，时间复杂度O(log(N)+M)，M为本次返回的member数
    2.ZRANGEBYSCORE/ZREVRANGEBYSCORE：返回指定Sorted Set中指定score范围内的所有member，返回结果以
        升序/降序排序，min和max可以指定为-inf和+inf，代表返回所有的member。时间复杂度O(log(N)+M)
    3.ZREMRANGEBYRANK/ZREMRANGEBYSCORE：移除Sorted Set中指定排名范围/指定
        score范围内的所有member。时间复杂度O(log(N)+M)            
上述几个命令，应尽量避免传递[0 -1]或[-inf +inf]这样的参数，来对Sorted Set做
一次性的完整遍历，特别是在Sorted Set的尺寸不可预知的情况下。可以通过ZSCAN命令
来进行游标式的遍历.
</code></pre><h4 id="5-Hash"><a href="#5-Hash" class="headerlink" title="5.Hash"></a>5.Hash</h4><pre><code>1.Hash即哈希表，Redis的Hash和传统的哈希表一样，是一种field-value型的数据结构，可以理解成将HashMap搬入Redis；
2.Hash非常适合用于表现对象类型的数据，用Hash中的field对应对象的field即可，hash特别适合用于存储对象,
Redis 中每个hash可以存储 232-1键值对(40多亿).

    1.HSET：将key对应的Hash中的field设置为value。如果该Hash不存在，会自动创建一个。时间复杂度O(1)
    2.HGET：返回指定Hash中field字段的值，时间复杂度O(1)
    3.HMSET/HMGET：同HSET和HGET，可以批量操作同一个key下的多个field，时间
        复杂度：O(N)，N为一次操作的field数量
    4.HSETNX：同HSET，但如field已经存在，HSETNX不会进行任何操作，时间复杂度O(1)
    5.HEXISTS：判断指定Hash中field是否存在，存在返回1，不存在返回0，时间复杂度O
        (1)HDEL：删除指定Hash中的field（1个或多个），时间复杂度：O(N)，N为操作的field数量
    6.HINCRBY：同INCRBY命令，对指定Hash中的一个field进行INCRBY，时间复杂度O(1)
应谨慎使用的Hash相关命令：
    1.HGETALL：返回指定Hash中所有的field-value对。返回结果为数组，数组中field和value交替出现。时间复杂度O(N)
    2.HKEYS/HVALS：返回指定Hash中所有的field/value，时间复杂度O(N)
上述三个命令都会对Hash进行完整遍历，Hash中的field数量与命令的耗时线性相关，对于尺寸不可预知的Hash，
应严格避免使用上面三个命令，而改为使用HSCAN命令进行游标式的遍历
</code></pre><h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><pre><code>redis除了支持数据类型之外还支持消息队列：生产者消费者模式和发布者订阅者模式.

生产者消费者模式:
    1.微服务架构是将比如多个war包分开部署作为独立的小服务，这些服务之间存在着相互
    调用的关系，他们是通过特殊的管道发送消息，其他服务也会监听这个管道，当有消息过
    来时会读取处理完后再发送到管道给其他服务去完成整个过程，然后再返回给用户.
    2.常用的软件还有RabbitMQ、Kafka、RocketMQ、ActiveMQ等.
redis实现生产者消费者模式：
    1.生产者发布消息
        192.168.34.117:6379&gt; LPUSH channel1 msg1 #从管道的左侧写入
        (integer) 1
        192.168.34.117:6379&gt; LPUSH channel1 msg2
        (integer) 2
        192.168.34.117:6379&gt; LPUSH channel1 msg3
        (integer) 3
    2.查看队列所有消息
        192.168.34.117:6379&gt; LRANGE channel1  0  -1 
        1) &quot;msg3&quot;
        2) &quot;msg2&quot;
        3) &quot;msg1&quot;
    3.消费者消费消息
        192.168.34.117:6379&gt; RPOP channel1  #从管道的右侧消费
        &quot;msg1&quot;
    4.再次验证队列消息
        192.168.34.117:6379&gt; LRANGE channel1  0  -1
        1) &quot;msg3&quot;
        2) &quot;msg2&quot;   #队列中的msg1消息已经被消费了，只剩两条消息了.

发布者订阅模式：
    在发布者订阅者模式下，发布者将消息发布到指定的channel里面，凡是监听该channel的消费者都会收到
    同样的一份消息，这种模式类似于是收音机模式，即凡是收听某个频道的听众都会收到主持人发布的相同的消息内容
redis实现发布者订阅模式：
    1.订阅者监听频道
        192.168.34.117:6379&gt; SUBSCRIBE channel2   #订阅消息
        Reading messages... (press Ctrl-C to quit)
        1) &quot;subscribe&quot;
        2) &quot;channel2&quot;
        3) (integer) 1
    2.发布者发布消息
        192.168.34.117:6379&gt; PUBLISH channel2 test1  #发布消息
        (integer) 1
    3.各订阅者得到验证消息
        192.168.34.117:6379&gt; SUBSCRIBE channel2
        Reading messages... (press Ctrl-C to quit)
        1) &quot;subscribe&quot;
        2) &quot;channel2&quot;
        3) (integer) 1
        1) &quot;message&quot;
        2) &quot;channel2&quot;
        3) &quot;test1&quot;        #此时订阅此频道的就可以看到消息了
</code></pre><h3 id="Redis常用命令"><a href="#Redis常用命令" class="headerlink" title="Redis常用命令"></a>Redis常用命令</h3><pre><code>1.CONFIG：
    config命令用于查看当前redis配置、以及不重启更改redis配置等。config可以完成绝大多数的redis.config文件中的配置.

    示例：直接更改最大内存，而且是立即生效的
        192.168.34.117:6379&gt; CONFIG set maxmemory 8589934592
        OK
        127.0.0.1:6379&gt; CONFIG get maxmemory 
        1) &quot;maxmemory&quot;
        2) &quot;8589934592&quot;
    示例：查看redis的配置信息
        192.168.34.117:6379&gt; CONFIG GET *
          1) &quot;dbfilename&quot;
          2) &quot;redis_6379.rdb&quot;
          3) &quot;requirepass&quot;
          4) &quot;&quot;
          5) &quot;masterauth&quot;
          213) &quot;bind&quot;
          214) &quot;192.168.34.117&quot;
        #ONFIG GET *看到的奇数行是配置，偶数行是它的值
    示例:更改密码
        192.168.34.117:6379&gt; CONFIG SET requirepass 123456
        OK

2.INFO
    显示当前节点redis运行状态信息
    # Server            #server端配置信息
    # Clients           #client端配置信息
    # Memory            #Memory配置信息
    # Persistence       #rbd和aof持久化配置信息
    # Stats             #当前状态
    # Replication       #集群相关信息(配置完集群查看是否正常)
    # CPU               #CPU配置信息
    # Cluster           #集群信息
    # Keyspace          #redis的键时间通知

3.SELECT
    切换数据库
        192.168.34.117:6379&gt; SELECT 6
        OK
        #redis是基于库做的隔离，不同的库是为了存放不同类型的key

4.keys
    查看当前库下的所有key
    注意：
        在redis数据量大的时候，禁止使用keys *命令，严重情况下回造成redis服务器的
        IO爆满而出现故障！可以先用DBSIZE看一下有多少个key!

5.BGSAVE：非阻塞
    手动在后台执行RDB持久化操作，会立即启动一个后台进程做快照
    192.168.34.117:6379[6]&gt; BGSAVE
    Background saving started
6.SAVE：阻塞
    执行SAVE时，数据量比较大时，需要几秒甚至更长的时间将数据保存到磁盘上，如果再SAVE过程中，写入请求会中断
    的，可能会造成数据丢失，所以一般用BGSAVE.

7.DBSIZE
    显示当前库下的所有key数量
    192.168.34.117:6379&gt; DBSIZE
    (integer) 2

8.FLUSHDB
    强制清空当前库中的所有key,慎重使用！
9.FLUSHALL
    强制清空当前redis服务器所有数据库中的所有key，即删除所有数据,慎重使用！
10.CLIENT命令
    127.0.0.1:6379[1]&gt; CLIENT LIST
        #显示连进来的客户端
    127.0.0.1:6379[1]&gt; CLIENT KILL
        #关闭客户端+id或者ip+port

11.redis的事务
    1.事务操作是原子性的就是要么都执行要么都不执行，为了保证事务本身的特性，还可以撤销事务之前所做的操作；
    2.redis也是支持事务的，虽然不支持撤销功能，但可以保证将多个命令打包成一个然后一次性的按顺序执行多个命令的机
    制，并且在事务执行期间服务器不会中断事务而改变去执行其他客户端命令的请求，它会将事务中的所有命令执行完毕然后
    才会处理其他命令请求；
    3.redis通过MULTI,EXEC,WATCH等命令实现事务功能，但是仅仅是实现了将多个命令打包然后一次性的按顺序执行多个命令的机制；
</code></pre><h3 id="Redis数据持久化"><a href="#Redis数据持久化" class="headerlink" title="Redis数据持久化"></a>Redis数据持久化</h3><pre><code>redis虽然是一个内存级别的缓存程序，即redis是使用内存进行数据的缓存的，但是其可以将内存的数据按照一定的策略保存到
硬盘上，从而实现数据持久保存的目的，redis支持两种不同方式的数据持久化保存机制，分别是RDB和AOF.

必须使用数据持久化吗？
    但通常来说，仍然建议至少开启RDB方式的数据持久化，因为：
        1.RDB方式的持久化几乎不损耗Redis本身的性能，在进行RDB持久化时，Redis主进
            程唯一需要做的事情就是fork出一个子进程，所有持久化工作都由子进程完成
        2.Redis无论因为什么原因crash掉之后，重启时能够自动恢复到上一次RDB快照中记
            录的数据。这省去了手工从其他数据源（如DB）同步数据的过程，而且要比其他任何的数据恢复方式都要快
        3.现在硬盘那么大，真的不缺那一点地方.

Redis的持久化:
    RDB：snapshotting, 二进制格式；按事先定制的策略，周期性地将数据从内存同步至磁盘；数据文件默认为dump.rdb；
        客户端显式使用SAVE或BGSAVE命令来手动启动快照保存机制；
            SAVE：同步，即在主线程中保存快照，此时会阻塞所有客户端请求；
            BGSAVE：异步；backgroud
        RDB是完全备份，所以可能会丢失数据；
    AOF：Append Only File, fsync
        记录每次写操作至指定的文件尾部实现的持久化；当redis重启时，可通过重新执行文件中的命令在内存中重建出数据库；
            BGREWRITEAOF：AOF文件重写；
                不会读取正在使用AOF文件，而是通过将内存中的数据以命令的方式保存至临时文件中，完成之后替换原来的AOF文件；
RBD:基于时间的快照技术，在save 900 1，在900秒内有一个键内容发生更改就快照机制；
在同时开启AOF和RBD时，因为AOF的级别比RBD高会使用AOF模式.
AOF：类似于数据库的binlog，将文件拷贝走，放到另外一台redis的数据目录，自动恢复
    AOF中记录的是每次在redis的操作，和mysql的bin-log类似;

生产环境：
    1.生产环境下，一般在Slave服务器上同时开启AOF和RDB，Master上只开启RBD.但是生产环境下是需要做集群来解决数据高可用的问题.
    2.不建议同时开启RBD和AOF，会对I/O性能影响很高
    3.如果一定要同时开启两种持久化方式，最好是把他们放在两个不同的后端存储系统上；
    4.如果同时启用时，当出现故障时一定要用AOF恢复，因为它恢复的数据量更多；
</code></pre><h4 id="RDB模式：snapshotting"><a href="#RDB模式：snapshotting" class="headerlink" title="RDB模式：snapshotting"></a>RDB模式：snapshotting</h4><pre><code>redis的RDB的快照机制是直接把redis放在内存中的数据所占用的内存空间直接原样不动的复刻一份放到磁盘上,它是一个二进制文件;
    即把在内存中的数据和它的结构通通转为文件格式放到磁盘上,恢复时会从文件中读取，读取到内存中恢复为在内存空间中的空间结构和数据；

RDB：基于时间的快照，默认只保留当前最新的一次快照(会把上一次的快照切换掉)，特点
是执行速度比较快，缺点是可能会丢失从上次快照到当前快照未完成之间的数据(即在两次快照时间之间redis服务可能出现故障，数据会丢失);如果是AOF模式，则不会发生此问题.

RDB实现的具体过程：
    1.Redis从主进程先fork出一个子进程，使用写时复制(COW)机制，子进程将内存的数据保存为一个临时文件，比如
    dump.rdb.temp，当数据保存完成之后再将上一次保存的RDB文件替换掉，然后关闭子进程，这样可以保存每一次做RDB快照
    的时候保存的数据都是完整的，因为直接替换RDB文件的时候可能会出现突然断电等问题而导致RDB文件还没有保存完整就突
    然关机停止保存而导致数据丢失的情况，可以手动将每次生成的RDB文件进程备份，这样可以最大化保存历史数据。
    2.因为会单独开一个子进程负责做快照，所以不影响redis的读写请求.
    3.Redis是先将数据写入到一个临时文件中，并且写成功了才会保存到打算要存的文件中，所以一般来讲只要备份下来rdb文件总是可用的；
    4.当然也可以连到redis之后，执行SAVE或者BGSAVE命令启动快照保存机制，每隔多长时间执行一次手动RBD数据备份；
    但是：
        SAVE:
            是在主线程保存快照，这就意味着在SAVE保存完成之前，此时会阻塞所有客户端请求，因为它是同步保存而且在主线程中实现；
            都是完整(全量)的将内存中的数据写入到磁盘当中，而不是增量方式，如果内存中数据量比较大时，必然会影响性能；
        BGSAVE:
            异步方式实现，当我们启动BGSAVE以后，他将立即返回结果告诉已经启动了，然后自动在后台实现保存操作，所以客户端主进程是不会被阻塞的！
所以一般是通过在脚本中使用BGSAVE命令执行手动RBD数据备份操作!!!
RDB模式的优缺点：
    优点：
        1.RDB快照保存了某个时间点的数据，可以通过脚本执行bgsave(非阻塞)或者save(阻塞)命令自定义时间点备份，可以保留多个备份，当出现问题可以恢复到不同时间点的版本。
        2.可以最大化o的性能，因为父进程在保存RDB 文件的时候唯一要做的是fork出一个子进程，然后的-操作都会有这个子进程操作，父进程无需任何的IO操作;
        3.RDB在大量数据比如几个G的数据，恢复的速度比AOF的快；
    因为RDB是直接将几个G的文件导入到内存中，AOF中记录的是几千上万行的操作命令，
        在数据恢复时，需要逐行执行.

    缺点：
        1-不能实时的保存数据，会丢失自上一次执行RDB备份到当前的内存数据；
        2-数据量非常大的时候，从父进程fork的时候需要一点时间，可能是毫秒或者秒；
</code></pre><h3 id="生产环境下遇到的坑："><a href="#生产环境下遇到的坑：" class="headerlink" title="生产环境下遇到的坑："></a>生产环境下遇到的坑：</h3><pre><code>redis RDB持久化模式有坑,因为我们使用的服务器是机械硬盘，读写性能和SSD固态硬盘相差很大，服务器内存是128G，当时给
redis分了最大内存是120G，每fork一次就出来一个新的进程，但是在此触发持久化的条件后又会fork一个进程出来，前一个还
未写到硬盘中，后一个fork已经出现孙子辈的了，甚至重孙辈的，导致服务器资源耗尽，宕机。还有个redis强烈建议内网使用，
程序调用也是内网，程序调用也是内网，程序调用也是内网。因为有一次被黑就是redis在公网上跑，还没有设置密码,导致将近
20台服务器被黑。
</code></pre><h4 id="AOF模式-append-only-file"><a href="#AOF模式-append-only-file" class="headerlink" title="AOF模式:append only file"></a>AOF模式:append only file</h4><pre><code>1.AOF日志的全称是Append Only File，从名字上我们就能看出来，它就是把redis的每个操作命令都以追加的方式写入的日志文件尾部；
2.与一般数据库不同的是，AOF文件是可识别的纯文本，它的内容就是一个个的Redis标准命令
3.类似于mysql的bin-log日志；

AOF:按照用户或Web服务器的操作顺序依次将操作添加到指定的日志文件当中，特点是数据安全性相对较高，缺点是即使有些操作是重复的也会全部记录.

AOF有二个显著缺陷：
    1.用fsync来解决数据同步不及时的问题
        1.因为linux内核写数据的时候，其实不是直接写磁盘的，而是先把写操作放到内存完成，然后同步到磁盘中的；
        2.内核将内存中的数据同步到磁盘的时间是不确定的，因为在内核中有个脏页数据同步策略，写数据-&gt;内存-&gt;由内核
        同步到内核内存-&gt;磁盘，由于同步时间的不确定，在断电之前的内核内存中需要同步的数据就丢失了,所以为了避免出
        现这种问题就使用fsync;
        3.在内核有一个库调用叫fsync(文件同步)，它的工作逻辑是当需要把数据祈请给内核中，内核不但要把数据保存到内核内存中，还要立即同步到磁盘文件中去；
        4.而我们只需要调用了fsync，就不会按照内核自己的管理调用方式待会再同步到磁盘，而是立即同步到磁盘，确保了数据一定是保存在磁盘上了；
        5.由于内核之所以会使用脏页数据同步策略，就是为了提高IO性能的，而我们却通过
        fsync强行同步到磁盘中了，这样一来每秒钟同步的次数就相当多了，而机械硬盘1s也就100个I/O，像SSD能有500IO/s,而PCIE这样的硬盘能达到上万的IO，但价格是
        相当昂贵的；
    2.AOF的rewrite
        1.在redis中一个key以counter来计数通过INCR使得数据增长，如果INCR了20w次，在AOF中也会记录20w行
        INCR-counter，不但造成AOF文件过大而且恢复时也会很慢；
        2.而这种情况无非就是将counter直接变成20w次，所以为了避免AOF文件过大，必要每隔一段时间对这个key重写一遍
        N个合并成一个即可，这叫做AOF的rewrite;这样一来文件的体积就很小，恢复时重放也不会很慢了；

AOF实现的具体过程:
    AOF和RDB一样使用了写时复制机制，AOF默认为每秒钟fsync一次，即将执行的命令保存到AOF文件当中，这样即使redis
    服务器发生故障的话顶多也就丢失1秒钟之内的数据，也可以设置不同的fsync策略，或者设置每次执行命令的时候执行
    fsync，fsync会在后台执行线程，所以主线程可以继续处理用户的正常请求而不受到写入AOF文件的IO影响
AOF的优点：
    1.最安全，在启用appendfsync always时(fsync是同步内存中redis所有已经修改
        的文件到存储设备)，任何已写入的数据都不会丢失，使用在启用appendfsync everysec也至多只会丢失1秒的数据。
    2.AOF文件在发生断电等问题时也不会损坏，即使出现了某条日志只写入了一半的情况，
        也可以使用redis-check-aof工具轻松修复。
    3.AOF文件易读，可修改，在进行了某些错误的数据清除操作后，只要AOF文件没有
        rewrite，就可以把AOF文件备份出来，把错误的命令删除，然后恢复数据。

AOF模式缺点:
    1.AOF文件通常比RDB文件更大
    2.磁盘IO性能消耗比RDB高(fsync机制的原因)
    3.数据恢复速度比RDB慢
</code></pre><h3 id="redis一键安装脚本和启动脚本"><a href="#redis一键安装脚本和启动脚本" class="headerlink" title="redis一键安装脚本和启动脚本"></a>redis一键安装脚本和启动脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-node ~]# cd /usr/local/src/</span><br><span class="line">[root@redis-node src]# ll redis-4.0.1.tar.gz</span><br><span class="line">-rw-rw-r-- 1 root root 1711660 Aug 27 16:19 redis-5.0.3.tar.gz</span><br><span class="line">[root@redis-node src]# cat redis_install.sh</span><br><span class="line">#!/usr/bin/env bash</span><br><span class="line"># It&apos;s Used to be install redis.</span><br><span class="line"># Created on 2018/03/06 .</span><br><span class="line"># author: lk.</span><br><span class="line"># Version: 1.0</span><br><span class="line">    </span><br><span class="line">function install_redis () &#123;</span><br><span class="line">###########################################################################</span><br><span class="line">        cd /usr/local/src</span><br><span class="line">        tar -zxvf /usr/local/src/redis-5.0.3.tar.gz</span><br><span class="line">        cd redis-5.0.3</span><br><span class="line">        make PREFIX=/usr/local/redis install</span><br><span class="line">        mkdir -p /usr/local/redis/&#123;etc,var&#125;</span><br><span class="line">        rsync -avz redis.conf  /usr/local/redis/etc/</span><br><span class="line">        sed -i &apos;s@pidfile.*@pidfile /var/run/redis-server.pid@&apos; /usr/local/redis/etc/redis.conf</span><br><span class="line">        sed -i &quot;s@logfile.*@logfile /usr/local/redis/var/redis.log@&quot; /usr/local/redis/etc/redis.conf</span><br><span class="line">        sed -i &quot;s@^dir.*@dir /usr/local/redis/var@&quot; /usr/local/redis/etc/redis.conf</span><br><span class="line">        sed -i &apos;s/daemonize no/daemonize yes/g&apos; /usr/local/redis/etc/redis.conf</span><br><span class="line">        sed -i &apos;s/^# bind 127.0.0.1/bind 0.0.0.0/g&apos; /usr/local/redis/etc/redis.conf</span><br><span class="line"> ##########################################################################</span><br><span class="line">&#125;</span><br><span class="line">install_redis</span><br><span class="line"></span><br><span class="line">赋予脚本执行权限,并进行安装</span><br><span class="line">[root@redis-node src]# chmod 755 /usr/local/src/redis_install.sh</span><br><span class="line">[root@redis-node src]# /bin/bash -x /usr/local/src/redis_install.sh</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">编写redis-server启动脚本</span><br><span class="line">[root@redis-node src]# cat /etc/init.d/redis-server</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line"># redis - this script starts and stops the redis-server daemon</span><br><span class="line">#</span><br><span class="line"># chkconfig:   - 85 15</span><br><span class="line"># description:  Redis is a persistent key-value database</span><br><span class="line"># processname: redis-server</span><br><span class="line"># config:      /usr/local/redis/etc/redis.conf</span><br><span class="line"># config:      /etc/sysconfig/redis</span><br><span class="line"># pidfile:     /usr/local/redis/var/redis-server.pid</span><br><span class="line">   </span><br><span class="line"># Source function library.</span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line">   </span><br><span class="line"># Source networking configuration.</span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line">   </span><br><span class="line"># Check that networking is up.</span><br><span class="line">[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0</span><br><span class="line">   </span><br><span class="line">redis=&quot;/usr/local/redis/bin/redis-server&quot;</span><br><span class="line">prog=$(basename $redis)</span><br><span class="line">   </span><br><span class="line">REDIS_CONF_FILE=&quot;/usr/local/redis/etc/redis.conf&quot;</span><br><span class="line">   </span><br><span class="line">[ -f /etc/sysconfig/redis ] &amp;&amp; . /etc/sysconfig/redis</span><br><span class="line">   </span><br><span class="line">lockfile=/var/lock/subsys/redis-server</span><br><span class="line">   </span><br><span class="line">start() &#123;</span><br><span class="line">    [ -x $redis ] || exit 5</span><br><span class="line">    [ -f $REDIS_CONF_FILE ] || exit 6</span><br><span class="line">    echo -n $&quot;Starting $prog: &quot;</span><br><span class="line">    daemon $redis $REDIS_CONF_FILE</span><br><span class="line">    retval=$?</span><br><span class="line">    echo</span><br><span class="line">    [ $retval -eq 0 ] &amp;&amp; touch $lockfile</span><br><span class="line">    return $retval</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">stop() &#123;</span><br><span class="line">    echo -n $&quot;Stopping $prog: &quot;</span><br><span class="line">    killproc $prog</span><br><span class="line">    retval=$?</span><br><span class="line">    echo</span><br><span class="line">    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile</span><br><span class="line">    return $retval</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">restart() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">reload() &#123;</span><br><span class="line">    echo -n $&quot;Reloading $prog: &quot;</span><br><span class="line">    killproc $redis -HUP</span><br><span class="line">    RETVAL=$?</span><br><span class="line">    echo</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">force_reload() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">rh_status() &#123;</span><br><span class="line">    status $prog</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">rh_status_q() &#123;</span><br><span class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; exit 0</span><br><span class="line">        $1</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || exit 0</span><br><span class="line">        $1</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        $1</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || exit 7</span><br><span class="line">        $1</span><br><span class="line">        ;;</span><br><span class="line">    force-reload)</span><br><span class="line">        force_reload</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        rh_status</span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || exit 0</span><br><span class="line">            ;;</span><br><span class="line">    *)</span><br><span class="line">        echo $&quot;Usage: $0 &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload&#125;&quot;</span><br><span class="line">        exit 2</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">赋予脚本执行权限,并启动redis-server</span><br><span class="line">[root@redis-node src]# /etc/init.d/redis-server start</span><br><span class="line">[root@redis-node src]# lsof -i:6379</span><br><span class="line">COMMAND     PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 24439 root    6u  IPv4 24642923      0t0  TCP dns02.kevin.cn:6379 (LISTEN)</span><br><span class="line"> </span><br><span class="line">温馨提示:</span><br><span class="line">需要将redis.conf文件中的bind改为本机ip.不能使用默认的127.0.0.1,否则远程连接该redis就会失败</span><br><span class="line">[root@redis-node src]# vim /usr/local/redis/etc/redis.conf</span><br><span class="line">.....</span><br><span class="line">bind 192.168.34.118</span><br><span class="line"> </span><br><span class="line">重启redis-server服务</span><br><span class="line">[root@redis-node src]# /etc/init.d/redis-server restart</span><br><span class="line">Stopping redis-server:                                     [  OK  ]</span><br><span class="line">Starting redis-server:                                     [  OK  ]</span><br><span class="line">[root@redis-node src]# lsof -i:6379</span><br><span class="line">COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME</span><br><span class="line">redis-ser 8184 root    6u  IPv4 24688720      0t0  TCP dns02.kevin.cn:6379 (LISTEN)</span><br><span class="line"> </span><br><span class="line">最好在tomcat两个节点上使用&quot;telnet 192.168.34.118 6379&quot;验证下redis是否能成功连接</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

<div>
  
      <div>
    
        <div style="text-align:center;color: #FF0000;font-size:16px;">-------------------码字不易<i class="fa fa-heart"></i>尊重原创<i class="fa fa-heart"></i>转载标注<i class="fa fa-heart"></i>不胜感激-------------------</div>
    
</div>
  
</div>
<div>
      
        
      
</div>
    

    
       
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Coffee or Tea？</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="空腹吃早餐 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="空腹吃早餐 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag"><i class="fa fa-tag"></i> redis</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/26/nginx实现四层和七层负载均衡/" rel="next" title="nginx实现四层和七层负载均衡">
                <i class="fa fa-chevron-left"></i> nginx实现四层和七层负载均衡
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/28/Kubernetes-监控Heapster和Dashboard/" rel="prev" title="Kubernetes-监控Heapster和Dashboard">
                Kubernetes-监控Heapster和Dashboard <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">
      
      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/haha.gif" alt="空腹吃早餐">
            
              <p class="site-author-name" itemprop="name">空腹吃早餐</p>
              <p class="site-description motion-element" itemprop="description">如果你也喜欢杰伦那我们就是好朋友 C'est la vie</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">75</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:liukui_work@163.com" title="E-Mail &rarr; mailto:liukui_work@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/a723bf5483d7" title="简书 &rarr; https://www.jianshu.com/u/a723bf5483d7" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i>简书</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/2879352237/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo &rarr; https://weibo.com/2879352237/profile?rightmod=1&wvr=6&mod=personinfo" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://music.163.com/#/user/home?id=321895687" title="CloudMusic &rarr; https://music.163.com/#/user/home?id=321895687" rel="noopener" target="_blank"><i class="fa fa-fw fa-music"></i>CloudMusic</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://shuinoo.github.io/" title="https://shuinoo.github.io/" rel="noopener" target="_blank">蔡shuishui</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://litten.me/" title="http://litten.me/" rel="noopener" target="_blank">litten</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jysperm.me/" title="https://jysperm.me/" rel="noopener" target="_blank">Mr wang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ephen.me/" title="https://ephen.me/" rel="noopener" target="_blank">Ephen</a>
                  </li>
                
              </ul>
            </div>
          
          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存基础介绍"><span class="nav-number">1.</span> <span class="nav-text">缓存基础介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-系统缓存：buffer与cache"><span class="nav-number">2.</span> <span class="nav-text">1.系统缓存：buffer与cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-CDN缓存"><span class="nav-number">3.</span> <span class="nav-text">2.CDN缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-应用层缓存"><span class="nav-number">4.</span> <span class="nav-text">3.应用层缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-其他缓存"><span class="nav-number">5.</span> <span class="nav-text">4.其他缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis和Memcached"><span class="nav-number">6.</span> <span class="nav-text">Redis和Memcached</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis安装"><span class="nav-number">7.</span> <span class="nav-text">Redis安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis配置文件详解"><span class="nav-number">8.</span> <span class="nav-text">Redis配置文件详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis的数据结构和常用命令"><span class="nav-number">9.</span> <span class="nav-text">Redis的数据结构和常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-字符串-String"><span class="nav-number">9.1.</span> <span class="nav-text">1.字符串:String</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-列表：和ELK相关，基于管道插入多个数据"><span class="nav-number">9.2.</span> <span class="nav-text">2.列表：和ELK相关，基于管道插入多个数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-集合-Set"><span class="nav-number">9.3.</span> <span class="nav-text">3.集合:Set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-有序集合：sorted-set"><span class="nav-number">9.4.</span> <span class="nav-text">4.有序集合：sorted set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-Hash"><span class="nav-number">9.5.</span> <span class="nav-text">5.Hash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息队列"><span class="nav-number">10.</span> <span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis常用命令"><span class="nav-number">11.</span> <span class="nav-text">Redis常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis数据持久化"><span class="nav-number">12.</span> <span class="nav-text">Redis数据持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB模式：snapshotting"><span class="nav-number">12.1.</span> <span class="nav-text">RDB模式：snapshotting</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产环境下遇到的坑："><span class="nav-number">13.</span> <span class="nav-text">生产环境下遇到的坑：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF模式-append-only-file"><span class="nav-number">13.1.</span> <span class="nav-text">AOF模式:append only file</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis一键安装脚本和启动脚本"><span class="nav-number">14.</span> <span class="nav-text">redis一键安装脚本和启动脚本</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

      <div style="">
  <canvas id="canvas" style="width:70%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">空腹吃早餐</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">1.8m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">26:55</span>
  
</div>









<!-- 网站运行时间的设置 -->
<center>
    <font size="3" color="#FF0000">Coool's Blog已运行:<span id="run_time" style="color:#DB70DB"></span></font>  Sometimes your whole life boils down to one insame move.
</center>

<script>
    function runTime() {
        var d = new Date(),str = '';
        BirthDay=new Date("Nov 18,2017");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        str = ""+daysold+"天";
        str += d.getHours()+'时'; 
        str  += d.getMinutes()+'分'; 
        str+= d.getSeconds()+'秒'; 
        return str;
    }
    setInterval(function(){$('#run_time').html(runTime())},1000);
</script>


        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="255,0,0" opacity="1" zindex="-1" count="230" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="/js/src/Valine.min.js"></script>

  <!-- https://deserts.io/diy-a-comment-system/ -->
  <script type="text/javascript">
    new Valine({
        lang: 'zh-cn',
        admin_email: '645150765@qq.com', //博主邮箱
        el: '#comments' ,
        appId: 'vk3KaAky0698trITaDye8Tul-gzGzoHsz',
        appKey: '3KISEUBblfzGHUAGvFxJvEyo',
        emoticon_url: 'https://cloud.panjunwen.com/alu',
        emoticon_list: ["吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
        placeholder: '帅的人已经评论',
  });

  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>